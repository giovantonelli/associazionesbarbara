<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Soci - Associazione Santa Barbara APS</title>
    <meta name="description" content="Accesso riservato ai soci dell'Associazione Santa Barbara APS">
    <meta name="keywords" content="area soci, login, accesso riservato, associazione">
    
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    
    <!-- Google tag (gtag.js) with Consent Mode -->
    <script>
      // Define dataLayer and the gtag function
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      
      // Set default consent to 'denied' as a placeholder for EU users
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'denied',
        'wait_for_update': 500
      });
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F465WJF33T"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      
      gtag('js', new Date());
      gtag('config', 'G-F465WJF33T');
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <img src="../assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="logo">
                <span class="brand-text">Associazione Santa Barbara APS</span>
            </div>
            <button class="nav-toggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="chi-siamo.html" class="nav-link">Chi siamo</a></li>
                <li><a href="attivita.html" class="nav-link">Attivit√†</a></li>
                <li><a href="eventi.html" class="nav-link">Eventi</a></li>
                <li><a href="galleria.html" class="nav-link">Galleria</a></li>
                <li><a href="faq.html" class="nav-link">FAQ</a></li>
                <li><a href="contatti.html" class="nav-link">Contatti</a></li>
                <li><a href="partner.html" class="nav-link">Partner</a></li>
                <li><a href="area-soci.html" class="nav-link btn btn-primary active">Area Soci</a></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1>Area Soci</h1>
            <p>Accesso riservato ai soci dell'associazione</p>
        </div>
    </section>

    <!-- Login Form -->
    <section id="login-form" class="login-section">
        <div class="container">
            <div class="login-form">
                <h2>Accedi alla tua area riservata</h2>
                <p>Utilizza il sistema di autenticazione sicuro Cloudflare Access per accedere ai contenuti riservati ai soci</p>
                
                <div class="oidc-auth">
                    <button id="login-btn" class="btn btn-primary btn-large">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Accedi all'Area Soci
                    </button>
                    
                    <div id="loading-state" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Autenticazione in corso...</p>
                    </div>
                    
                    <div id="auth-status" class="auth-status"></div>
                </div>
                
                <div class="login-help">
                    <p><strong>‚ÑπÔ∏è Come funziona:</strong></p>
                    <ul>
                        <li>Clicca su "Accedi all'Area Soci" per iniziare l'autenticazione</li>
                        <li>Sarai reindirizzato al sistema sicuro Cloudflare Access</li>
                        <li>Inserisci le tue credenziali autorizzate</li>
                        <li>Verrai automaticamente riportato all'area riservata</li>
                    </ul>
                    <p>Non hai ancora l'accesso? <a href="contatti.html">Contattaci</a> per richiedere l'abilitazione.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Authentication Debug Info (only for development) -->
    <section id="auth-debug" class="debug-section" style="display: none;">
        <div class="container">
            <div class="debug-info">
                <h3>üîß Debug Autenticazione (Solo Sviluppo)</h3>
                <div id="debug-content"></div>
            </div>
        </div>
    </section>

    <!-- Members Content (hidden by default) -->
    <section id="members-content" class="members-content" style="display: none;">
        <div class="container">
            <div class="members-welcome">
                <h2>Benvenuto nell'area soci!</h2>
                <div id="user-info" class="user-info">
                    <p><strong>Email:</strong> <span id="user-email">-</span></p>
                    <p><strong>Nome:</strong> <span id="user-name">-</span></p>
                    <p><strong>ID Utente:</strong> <span id="user-id">-</span></p>
                </div>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
            
            <!-- Dashboard -->
            <div class="members-dashboard">
                <div class="row">
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="dashboard-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="var(--primary-color)">
                                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                </svg>
                            </div>
                            <h3>Documenti</h3>
                            <p>Accedi a verbali, bilanci e documenti ufficiali</p>
                            <a href="#" class="btn btn-outline">Vai ai documenti</a>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="dashboard-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="var(--primary-color)">
                                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                </svg>
                            </div>
                            <h3>Eventi</h3>
                            <p>Calendario completo eventi e prenotazioni</p>
                            <a href="eventi.html" class="btn btn-outline">Vedi calendario</a>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="dashboard-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="var(--primary-color)">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </div>
                            <h3>Tessera</h3>
                            <p>Gestisci la tua tessera e rinnova l'iscrizione</p>
                            <a href="#" class="btn btn-outline">Gestisci tessera</a>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="dashboard-card">
                            <div class="dashboard-icon">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="var(--primary-color)">
                                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                </svg>
                            </div>
                            <h3>Comunicazioni</h3>
                            <p>Messaggi e comunicazioni dell'associazione</p>
                            <a href="#" class="btn btn-outline">Leggi messaggi</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Prossimi Eventi -->
            <div class="members-events">
                <h3>I tuoi prossimi eventi</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="event-summary">
                            <div class="event-date">
                                <span class="date-day">20</span>
                                <span class="date-month">LUG</span>
                            </div>
                            <div class="event-info">
                                <h4>Assemblea Ordinaria</h4>
                                <p>üìÖ 20 Luglio 2025, ore 20:00</p>
                                <p>üìç Sede Associazione</p>
                                <span class="event-status confirmed">Presenza confermata</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="event-summary">
                            <div class="event-date">
                                <span class="date-day">05</span>
                                <span class="date-month">AGO</span>
                            </div>
                            <div class="event-info">
                                <h4>Cena Sociale</h4>
                                <p>üìÖ 5 Agosto 2025, ore 19:30</p>
                                <p>üìç Ristorante Il Borgo</p>
                                <span class="event-status pending">In attesa di conferma</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Documenti Recenti -->
            <div class="members-documents">
                <h3>Documenti recenti</h3>
                <div class="documents-list">
                    <div class="document-item">
                        <div class="document-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--primary-color)">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </div>
                        <div class="document-info">
                            <h4>Verbale Assemblea Giugno 2025</h4>
                            <p>Pubblicato il 15 Giugno 2025</p>
                        </div>
                        <div class="document-actions">
                            <a href="#" class="btn btn-sm btn-outline">Scarica PDF</a>
                        </div>
                    </div>
                    
                    <div class="document-item">
                        <div class="document-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--primary-color)">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </div>
                        <div class="document-info">
                            <h4>Bilancio 2024</h4>
                            <p>Pubblicato il 30 Marzo 2025</p>
                        </div>
                        <div class="document-actions">
                            <a href="#" class="btn btn-sm btn-outline">Scarica PDF</a>
                        </div>
                    </div>
                    
                    <div class="document-item">
                        <div class="document-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--primary-color)">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </div>
                        <div class="document-info">
                            <h4>Programma Attivit√† 2025</h4>
                            <p>Pubblicato il 15 Gennaio 2025</p>
                        </div>
                        <div class="document-actions">
                            <a href="#" class="btn btn-sm btn-outline">Scarica PDF</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Profilo Socio -->
            <div class="member-profile">
                <h3>Il tuo profilo</h3>
                <div class="profile-info">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="profile-section">
                                <h4>Informazioni personali</h4>
                                <p><strong>Nome:</strong> Mario Rossi</p>
                                <p><strong>Email:</strong> info@associazionesbarbara.it</p>
                                <p><strong>Telefono:</strong> +39 123 456 7890</p>
                                <p><strong>Tessera n¬∞:</strong> 2025-001</p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="profile-section">
                                <h4>Stato iscrizione</h4>
                                <p><strong>Tipo:</strong> Socio ordinario</p>
                                <p><strong>Iscritto dal:</strong> 15 Gennaio 2020</p>
                                <p><strong>Scadenza:</strong> 31 Dicembre 2025</p>
                                <p><strong>Stato:</strong> <span class="status-active">Attivo</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <a href="#" class="btn btn-outline">Modifica profilo</a>
                    <a href="#" class="btn btn-primary">Rinnova tessera</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="footer-logo">
                    <p>Associazione Santa Barbara APS</p>
                    <p>Promuoviamo la cultura e il volontariato nel nostro territorio</p>
                </div>
                <div class="footer-section">
                    <h4>Link utili</h4>
                    <ul>
                        <li><a href="chi-siamo.html">Chi siamo</a></li>
                        <li><a href="attivita.html">Attivit√†</a></li>
                        <li><a href="eventi.html">Eventi</a></li>
                        <li><a href="contatti.html">Contatti</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Informazioni</h4>
                    <ul>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="area-soci.html">Area Soci</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Seguici</h4>
                    <div class="social-links">
                        <a href="https://www.facebook.com/santabarbara.grumoappula" class="social-link" aria-label="Facebook">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                        <a href="https://www.instagram.com/corteostoricosantabarbara/" class="social-link" aria-label="Instagram">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                        <a href="https://t.me/associazionesbarbara" class="social-link" aria-label="Telegram">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2008-<span id="current-year"></span> Associazione Santa Barbara APS. Tutti i diritti riservati.</p>
            </div>
        </div>
    </footer>

    <script src="assets/js/script.js"></script>
    
    <!-- OIDC Authentication Script -->
    <script>
        // OIDC Configuration
        const OIDC_CONFIG = {
            client_id: '3b71a23f7628bed97c76249561ac3b6a8d549710e976a7ce908a0267dd82e934',
            redirect_uri: 'https://associazionesbarbara.it/area-soci.html',
            authorization_endpoint: 'https://associazionesbarbara.cloudflareaccess.com/cdn-cgi/access/sso/oidc/3b71a23f7628bed97c76249561ac3b6a8d549710e976a7ce908a0267dd82e934/authorization',
            token_endpoint: 'https://associazionesbarbara.cloudflareaccess.com/cdn-cgi/access/sso/oidc/3b71a23f7628bed97c76249561ac3b6a8d549710e976a7ce908a0267dd82e934/token',
            userinfo_endpoint: 'https://associazionesbarbara.cloudflareaccess.com/cdn-cgi/access/sso/oidc/3b71a23f7628bed97c76249561ac3b6a8d549710e976a7ce908a0267dd82e934/userinfo',
            scope: 'openid email profile'
        };

        // Utility functions
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state'),
                error: params.get('error'),
                error_description: params.get('error_description')
            };
        }

        function showDebugInfo(title, data) {
            const debugSection = document.getElementById('auth-debug');
            const debugContent = document.getElementById('debug-content');
            
            const debugHtml = `
                <div class="debug-item">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            
            debugContent.innerHTML += debugHtml;
            debugSection.style.display = 'block';
        }

        function showAuthStatus(message, type = 'info') {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.className = `auth-status ${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        function showLoading(show = true) {
            document.getElementById('loading-state').style.display = show ? 'block' : 'none';
            document.getElementById('login-btn').style.display = show ? 'none' : 'block';
        }

        // OIDC Authentication Functions
        function startAuth() {
            try {
                showLoading(true);
                
                // Generate state parameter for security
                const state = generateRandomString(32);
                sessionStorage.setItem('oauth_state', state);
                
                // Build authorization URL
                const authUrl = new URL(OIDC_CONFIG.authorization_endpoint);
                authUrl.searchParams.set('client_id', OIDC_CONFIG.client_id);
                authUrl.searchParams.set('redirect_uri', OIDC_CONFIG.redirect_uri);
                authUrl.searchParams.set('response_type', 'code');
                authUrl.searchParams.set('scope', OIDC_CONFIG.scope);
                authUrl.searchParams.set('state', state);
                
                showDebugInfo('Authorization URL', {
                    url: authUrl.toString(),
                    state: state
                });
                
                showAuthStatus('Reindirizzamento al provider di autenticazione...', 'info');
                
                // Redirect to authorization endpoint
                setTimeout(() => {
                    window.location.href = authUrl.toString();
                }, 1000);
                
            } catch (error) {
                console.error('Error during auth start:', error);
                showAuthStatus('Errore durante l\'avvio dell\'autenticazione: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function handleAuthCallback() {
            try {
                const params = getUrlParams();
                showDebugInfo('URL Parameters', params);
                
                // Check for errors
                if (params.error) {
                    throw new Error(`Auth Error: ${params.error} - ${params.error_description || 'Unknown error'}`);
                }
                
                if (!params.code) {
                    return false; // No auth code, normal page load
                }
                
                showLoading(true);
                showAuthStatus('Codice di autorizzazione ricevuto, scambio con token...', 'info');
                
                // Verify state parameter
                const storedState = sessionStorage.getItem('oauth_state');
                if (!storedState || storedState !== params.state) {
                    throw new Error('State parameter mismatch - possibile attacco CSRF');
                }
                
                // Exchange code for token
                const tokenResponse = await exchangeCodeForToken(params.code);
                showDebugInfo('Token Response', tokenResponse);
                
                if (tokenResponse.access_token) {
                    // Get user info
                    const userInfo = await getUserInfo(tokenResponse.access_token);
                    showDebugInfo('User Info', userInfo);
                    
                    // Store token and show authenticated content
                    sessionStorage.setItem('access_token', tokenResponse.access_token);
                    sessionStorage.setItem('user_info', JSON.stringify(userInfo));
                    
                    showAuthenticatedContent(userInfo);
                    showAuthStatus('Autenticazione completata con successo!', 'success');
                } else {
                    throw new Error('Token non ricevuto dal server');
                }
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                return true;
                
            } catch (error) {
                console.error('Error during auth callback:', error);
                showAuthStatus('Errore durante l\'autenticazione: ' + error.message, 'error');
                return false;
            } finally {
                showLoading(false);
                sessionStorage.removeItem('oauth_state');
            }
        }

        async function exchangeCodeForToken(code) {
            // Prova prima l'endpoint backend (raccomandato)
            try {
                const response = await fetch('/auth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        code: code,
                        state: sessionStorage.getItem('oauth_state')
                    })
                });
                
                if (response.ok) {
                    const tokens = await response.json();
                    showDebugInfo('Backend Token Response', tokens);
                    return tokens;
                }
                
                throw new Error(`Backend token exchange failed: ${response.status}`);
                
            } catch (backendError) {
                console.warn('Backend token exchange failed, trying direct approach:', backendError);
                
                // Fallback: Tentativo diretto (probabilmente fallir√† per CORS)
                try {
                    const tokenData = {
                        grant_type: 'authorization_code',
                        client_id: OIDC_CONFIG.client_id,
                        code: code,
                        redirect_uri: OIDC_CONFIG.redirect_uri
                        // client_secret non incluso per sicurezza
                    };
                    
                    const response = await fetch(OIDC_CONFIG.token_endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: new URLSearchParams(tokenData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Direct token exchange failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const tokens = await response.json();
                    showDebugInfo('Direct Token Response', tokens);
                    return tokens;
                    
                } catch (directError) {
                    // Entrambi i metodi sono falliti, mostra informazioni debug
                    showAuthStatus(`
                        <h4>‚ö†Ô∏è Token Exchange Requirements</h4>
                        <p><strong>Authorization Code ricevuto:</strong></p>
                        <code style="word-break: break-all; background: #f0f0f0; padding: 5px; border-radius: 3px;">${code}</code>
                        
                        <div style="margin: 15px 0;">
                            <p><strong>Motivi del fallimento:</strong></p>
                            <ul style="text-align: left;">
                                <li><strong>Backend non disponibile:</strong> ${backendError.message}</li>
                                <li><strong>CORS Policy:</strong> ${directError.message}</li>
                                <li><strong>Client Secret:</strong> Richiesto per token exchange</li>
                            </ul>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <p><strong>üîß Per completare l'implementazione:</strong></p>
                            <ol style="text-align: left;">
                                <li>Deploy backend con endpoint <code>/auth/token</code></li>
                                <li>Configura client secret: <code>f398...8645</code></li>
                                <li>Implementa CORS headers appropriati</li>
                                <li>Testa il flusso completo</li>
                            </ol>
                        </div>
                        
                        <p><strong>üìã Configurazione corrente:</strong></p>
                        <ul style="text-align: left; font-family: monospace; font-size: 12px;">
                            <li>Client ID: ${OIDC_CONFIG.client_id}</li>
                            <li>Redirect URI: ${OIDC_CONFIG.redirect_uri}</li>
                            <li>Token Endpoint: ${OIDC_CONFIG.token_endpoint}</li>
                        </ul>
                    `, 'warning');
                    
                    // Restituisci oggetto con informazioni per debug
                    return {
                        auth_code: code,
                        backend_error: backendError.message,
                        direct_error: directError.message,
                        requires_backend: true,
                        client_secret_required: true
                    };
                }
            }
        }

        async function getUserInfo(accessToken) {
            // Prova prima l'endpoint backend proxy
            try {
                const response = await fetch('/auth/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    showDebugInfo('Backend UserInfo Response', userInfo);
                    return userInfo;
                }
                
                throw new Error(`Backend userinfo failed: ${response.status}`);
                
            } catch (backendError) {
                console.warn('Backend userinfo failed, trying direct approach:', backendError);
                
                // Fallback: Tentativo diretto
                try {
                    const response = await fetch(OIDC_CONFIG.userinfo_endpoint, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Direct UserInfo request failed: ${response.status}`);
                    }
                    
                    const userInfo = await response.json();
                    showDebugInfo('Direct UserInfo Response', userInfo);
                    return userInfo;
                    
                } catch (directError) {
                    console.error('Both UserInfo methods failed:', { backendError, directError });
                    
                    // Restituisci dati demo per continuare il test
                    const demoUserInfo = {
                        email: 'demo@associazionesbarbara.it',
                        name: 'Demo User',
                        given_name: 'Demo',
                        family_name: 'User',
                        sub: 'demo-user-id-' + Date.now(),
                        iss: 'cloudflare-access-demo',
                        aud: OIDC_CONFIG.client_id,
                        iat: Math.floor(Date.now() / 1000),
                        exp: Math.floor(Date.now() / 1000) + 3600,
                        _demo: true,
                        _backend_error: backendError.message,
                        _direct_error: directError.message
                    };
                    
                    showDebugInfo('Demo UserInfo (Errors occurred)', demoUserInfo);
                    return demoUserInfo;
                }
            }
        }

        function showAuthenticatedContent(userInfo) {
            // Hide login form
            document.getElementById('login-form').style.display = 'none';
            
            // Show members content
            document.getElementById('members-content').style.display = 'block';
            
            // Update user info
            document.getElementById('user-email').textContent = userInfo.email || 'N/A';
            document.getElementById('user-name').textContent = userInfo.name || userInfo.given_name || 'N/A';
            document.getElementById('user-id').textContent = userInfo.sub || 'N/A';
        }

        function logout() {
            // Clear stored data
            sessionStorage.removeItem('access_token');
            sessionStorage.removeItem('user_info');
            
            // Reset UI
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('members-content').style.display = 'none';
            document.getElementById('auth-status').style.display = 'none';
            document.getElementById('auth-debug').style.display = 'none';
            
            showAuthStatus('Logout effettuato', 'info');
        }

        function checkExistingAuth() {
            const token = sessionStorage.getItem('access_token');
            const userInfo = sessionStorage.getItem('user_info');
            
            if (token && userInfo) {
                try {
                    const parsedUserInfo = JSON.parse(userInfo);
                    showAuthenticatedContent(parsedUserInfo);
                    showAuthStatus('Sessione esistente ripristinata', 'success');
                } catch (error) {
                    console.error('Error parsing stored user info:', error);
                    logout();
                }
            }
        }

        // Event Listeners and Initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handler to login button
            document.getElementById('login-btn').addEventListener('click', startAuth);
            
            // Check for existing authentication
            checkExistingAuth();
            
            // Handle OAuth callback
            handleAuthCallback();
        });
    </script>
    
    <!-- Additional CSS for OIDC components -->
    <style>
        .btn-large {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .oidc-auth {
            text-align: center;
            margin: 30px 0;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .auth-status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .auth-status.info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1565c0;
        }
        
        .auth-status.success {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        
        .auth-status.error {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .auth-status.warning {
            background-color: #fff3e0;
            border: 1px solid #ff9800;
            color: #ef6c00;
        }
        
        .debug-section {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        .debug-info {
            font-family: monospace;
            font-size: 12px;
        }
        
        .debug-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .debug-item h4 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .debug-item pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 300px;
        }
        
        .user-info {
            background-color: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #b3d9ff;
        }
        
        .user-info p {
            margin: 10px 0;
            font-size: 16px;
        }
        
        .login-help ul {
            text-align: left;
            margin: 15px 0;
        }
        
        .login-help li {
            margin: 8px 0;
        }
    </style>
</body>
</html>
