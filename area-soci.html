<!DOCTYPE html>
<html lang="it">
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Soci - Associazione Santa Barbara APS</title>
  <meta name="description" content="Accesso riservato ai soci dell'Associazione Santa Barbara APS">
  <meta name="keywords" content="area soci, login, accesso riservato, associazione">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
  <script>
                        // Define dataLayer and the gtag function
                        window.dataLayer = window.dataLayer || [];

                        function gtag() {
                                dataLayer.push(arguments);
                        }
                        // Set default consent to 'denied' as a placeholder for EU users
                        gtag('consent', 'default', {
                                'ad_storage': 'denied',
                                'ad_user_data': 'denied',
                                'ad_personalization': 'denied',
                                'analytics_storage': 'denied',
                                'wait_for_update': 500
                        });
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-F465WJF33T"></script>
  <script>
                        gtag('js', new Date());
                        gtag('config', 'G-F465WJF33T');
  </script>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <a href="index.html" class="nav-brand-link"><img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="logo"> <span class="brand-text">Associazione Santa Barbara APS</span></a>
      </div><button class="nav-toggle" aria-label="Toggle navigation"></button>
      <ul class="nav-menu">
        <li>
          <a href="index.html" class="nav-link">Home</a>
        </li>
        <li>
          <a href="chi-siamo.html" class="nav-link">Chi siamo</a>
        </li>
        <li>
          <a href="attivita.html" class="nav-link">Attività</a>
        </li>
        <li>
          <a href="eventi.html" class="nav-link">Eventi</a>
        </li>
        <li>
          <a href="galleria.html" class="nav-link">Galleria</a>
        </li>
        <li>
          <a href="faq.html" class="nav-link">FAQ</a>
        </li>
        <li>
          <a href="contatti.html" class="nav-link">Contatti</a>
        </li>
        <li>
          <a href="partner.html" class="nav-link">Partner</a>
        </li>
        <li>
          <a id="logout-btn" class="btn btn-secondary">🚪 Logout</a>
        </li>
      </ul>
    </div>
  </nav>
  <section class="page-header">
    <div class="container">
      <h1>Area Soci</h1>
      <p>Accesso riservato ai soci dell'associazione</p>
    </div>
  </section>
  <div id="cookieBanner" class="cookie-banner">
    <div class="cookie-content">
      <p>Questo sito utilizza cookie per migliorare l'esperienza di navigazione. Continuando a navigare accetti l'uso dei cookie.</p>
      <div class="cookie-buttons">
        <button id="acceptCookies" class="btn btn-primary">Accetta</button> <button id="rejectCookies" class="btn btn-secondary">Rifiuta</button> <a href="privacy.html" class="btn btn-link">Privacy Policy</a>
      </div>
    </div>
  </div>
  <section id="members-content" class="members-content" style="display:none;">
    <div class="container">
      <div id="user-info" class="user-info"></div>
      <div class="content-section" style="margin-top: 30px;">
        <h3>⚙️ Gestione Profilo</h3>
        <p>Gestisci i tuoi dati e le preferenze dell'account</p>
        <div class="profile-management">
          <div class="profile-actions">
            <button id="edit-profile-btn" class="btn btn-outline">✏️ Modifica Profilo</button> <button id="change-password-btn" class="btn btn-outline">🔑 Cambia Password</button> <button id="change-email-btn" class="btn btn-outline">✉️ Cambia Email</button>
          </div>
        </div>
      </div>
      <div id="profile-edit-form" class="content-section" style="display: none; margin-top: 20px;">
        <h3>✏️ Modifica Profilo</h3>
        <form id="update-profile-form" name="update-profile-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="edit-firstName">Nome *</label> <input type="text" id="edit-firstName" name="firstName" required="">
            </div>
            <div class="form-group">
              <label for="edit-lastName">Cognome *</label> <input type="text" id="edit-lastName" name="lastName" required="">
            </div>
            <div class="form-group">
              <label for="edit-dateOfBirth">Data di Nascita</label> <input type="date" id="edit-dateOfBirth" name="dateOfBirth">
            </div>
            <div class="form-group">
              <label for="edit-placeOfBirth">Luogo di Nascita</label> <input type="text" id="edit-placeOfBirth" name="placeOfBirth">
            </div>
            <div class="form-group">
              <label for="edit-gender">Sesso *</label> <select id="edit-gender" name="gender" required="" class="form-input">
                <option value="">
                  Seleziona...
                </option>
                <option value="M">
                  Maschio
                </option>
                <option value="F">
                  Femmina
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-fiscalCode">Codice Fiscale</label> <input type="text" id="edit-fiscalCode" name="fiscalCode" pattern="[A-Z0-9]{16}" title="16 caratteri alfanumerici" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
              <label for="edit-phone">Telefono</label> <input type="tel" id="edit-phone" name="phone">
            </div>
            <div class="form-group">
              <label for="edit-address">Indirizzo</label> <input type="text" id="edit-address" name="address">
            </div>
            <div class="form-group">
              <label for="edit-city">Città</label> <input type="text" id="edit-city" name="city">
            </div>
            <div class="form-group">
              <label for="edit-zipCode">CAP</label> <input type="text" id="edit-zipCode" name="zipCode" pattern="[0-9]{5}" title="5 cifre" maxlength="5">
            </div>
            <div class="form-group">
              <label for="edit-province">Provincia</label> <input type="text" id="edit-province" name="province" pattern="[A-Z]{2}" title="2 lettere maiuscole" maxlength="2" style="text-transform: uppercase;">
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">💾 Salva Modifiche</button> <button type="button" id="cancel-edit-btn" class="btn btn-secondary">❌ Annulla</button>
          </div>
        </form>
      </div>
      <div id="password-change-form" class="content-section" style="display: none; margin-top: 20px;">
        <h3>🔑 Cambia Password</h3>
        <form id="update-password-form" name="update-password-form">
          <input type="text" id="username-for-password" name="username" autocomplete="username" value="" style="display:none;">
          <div class="form-group">
            <label for="current-password">Password Attuale *</label> <input type="password" id="current-password" name="currentPassword" required="" autocomplete="current-password">
          </div>
          <div class="form-group">
            <label for="new-password">Nuova Password *</label> <input type="password" id="new-password" name="newPassword" required="" minlength="8" autocomplete="new-password">
          </div>
          <div class="form-group">
            <label for="confirm-password">Conferma Nuova Password *</label> <input type="password" id="confirm-password" name="confirmPassword" required="" minlength="8" autocomplete="new-password">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">🔑 Cambia Password</button> <button type="button" id="cancel-password-btn" class="btn btn-secondary">❌ Annulla</button>
          </div>
        </form>
      </div>
      <div id="email-change-form" class="content-section" style="display: none; margin-top: 20px;">
        <h3>✉️ Cambia Email</h3>
        <form id="update-email-form" name="update-email-form">
          <div class="form-group">
            <label for="current-email">Email Attuale</label> <input type="email" id="current-email" name="currentEmail" readonly>
          </div>
          <div class="form-group">
            <label for="new-email">Nuova Email *</label> <input type="email" id="new-email" name="newEmail" required="">
          </div>
          <div class="form-group">
            <label for="confirm-new-email">Conferma Nuova Email *</label> <input type="email" id="confirm-new-email" name="confirmNewEmail" required="">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">✉️ Cambia Email</button> <button type="button" id="cancel-email-btn" class="btn btn-secondary">❌ Annulla</button>
          </div>
        </form>
      </div>
      
      <!-- Eventi Management Section -->
      <div class="content-section" style="margin-top: 30px;">
        <h3>📅 Gestione Eventi</h3>
        <p>Crea, modifica o elimina eventi dell'associazione</p>
        
        <div class="events-management">
          <div class="management-tabs">
            <button id="show-events-list" class="btn btn-primary active-tab">📋 Lista Eventi</button>
            <button id="show-create-event" class="btn btn-outline">➕ Nuovo Evento</button>
          </div>
          
          <!-- Lista Eventi -->
          <div id="events-list-section" class="management-section" style="margin-top: 20px;">
            <div id="events-table-container">
              <div class="table-responsive">
                <table id="admin-events-table" class="admin-table" style="width: 100%; border-collapse: collapse; background: white; table-layout: auto;">
                  <thead>
                    <tr style="background: #f8f9fa;">
                      <th style="padding: 12px; border: 1px solid #ddd; width: auto; min-width: 200px;">Titolo</th>
                      <th style="padding: 12px; border: 1px solid #ddd; width: auto; min-width: 100px; white-space: nowrap; text-align: center;">Data</th>
                      <th style="padding: 12px; border: 1px solid #ddd; width: auto; min-width: 120px; text-align: center;">Luogo</th>
                      <th style="padding: 12px; border: 1px solid #ddd; width: auto; min-width: 80px; text-align: center;">Pubblico</th>
                      <th style="padding: 12px; border: 1px solid #ddd; width: auto; min-width: 150px; text-align: center;">Azioni</th>
                    </tr>
                  </thead>
                  <tbody id="admin-events-tbody" style="border: 1px solid #ddd;">
                    <!-- Eventi caricati dinamicamente -->
                  </tbody>
                </table>
              </div>
              <div id="no-events-message" style="display: none; text-align: center; padding: 20px; color: #666;">
                Nessun evento trovato.
              </div>
            </div>
          </div>
          
          <!-- Form Creazione/Modifica Evento -->
          <div id="event-form-section" class="management-section" style="display: none; margin-top: 20px;">
            <div class="form-container">
              <h4 id="event-form-title">➕ Nuovo Evento</h4>
              <form id="event-management-form" name="event-management-form">
                <input type="hidden" id="event-id" name="eventId">
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div class="form-group">
                    <label for="event-title">Titolo Evento *</label>
                    <input type="text" id="event-title" name="title" required maxlength="255" class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label for="event-date">Data Evento *</label>
                    <input type="date" id="event-date" name="event_date" required class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label for="event-time">Orario</label>
                    <input type="text" id="event-time" name="event_time" placeholder="es. 18:00" class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label for="event-location">Luogo</label>
                    <input type="text" id="event-location" name="location" maxlength="255" class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label for="event-address">Indirizzo</label>
                    <input type="text" id="event-address" name="address" maxlength="500" class="form-input">
                  </div>
                  
                  <div class="form-group">
                    <label for="event-image-url">URL Immagine</label>
                    <input type="url" id="event-image-url" name="image_url" class="form-input" placeholder="https://...">
                  </div>
                  
                  <div class="form-group">
                    <label for="event-created-by">Creato da</label>
                    <select id="event-created-by" name="created_by" class="form-input">
                      <option value="">Seleziona utente...</option>
                      <!-- Opzioni caricate dinamicamente -->
                    </select>
                  </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                  <label for="event-description">Descrizione Breve</label>
                  <textarea id="event-description" name="description" rows="3" maxlength="500" class="form-input" placeholder="Descrizione breve dell'evento..."></textarea>
                </div>
                
                <div class="form-group">
                  <label for="event-content">Contenuto Completo</label>
                  <textarea id="event-content" name="content" rows="6" class="form-input" placeholder="Contenuto dettagliato dell'evento (supporta HTML)..."></textarea>
                </div>
                
                <div class="form-group">
                  <div class="checkbox-group">
                    <label class="checkbox-label">
                      <input type="checkbox" id="event-is-public" name="is_public" checked>
                      <span class="checkmark"></span>
                      Evento pubblico
                    </label>
                  </div>
                </div>
                
                <div class="form-actions" style="margin-top: 25px;">
                  <button type="submit" id="save-event-btn" class="btn btn-primary">💾 Salva Evento</button>
                  <button type="button" id="cancel-event-form" class="btn btn-secondary">❌ Annulla</button>
                  <button type="button" id="delete-event-btn" class="btn btn-danger" style="display: none;">🗑️ Elimina Evento</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="footer-logo">
          <p>Associazione Santa Barbara APS</p>
          <p>Promuoviamo la cultura e il volontariato nel nostro territorio</p>
        </div>
        <div class="footer-section">
          <h4>Link utili</h4>
          <ul>
            <li>
              <a href="chi-siamo.html">Chi siamo</a>
            </li>
            <li>
              <a href="attivita.html">Attività</a>
            </li>
            <li>
              <a href="eventi.html">Eventi</a>
            </li>
            <li>
              <a href="contatti.html">Contatti</a>
            </li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Informazioni</h4>
          <ul>
            <li>
              <a href="privacy.html">Privacy Policy</a>
            </li>
            <li>
              <a href="faq.html">FAQ</a>
            </li>
            <li>
              <a href="area-soci.html">Area Soci</a>
            </li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Seguici</h4>
          <div class="social-links">
            <a href="https://www.facebook.com/santabarbara.grumoappula" class="social-link" aria-label="Facebook"><svg width="24" height="24" viewbox="0 0 24 24" fill="currentcolor">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"></path></svg></a> <a href="https://www.instagram.com/corteostoricosantabarbara/" class="social-link" aria-label="Instagram"><svg width="24" height="24" viewbox="0 0 24 24" fill="currentcolor">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"></path></svg></a> <a href="https://t.me/associazionesbarbara" class="social-link" aria-label="Telegram"><svg width="24" height="24" viewbox="0 0 24 24" fill="currentcolor">
            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"></path></svg></a>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>© 2008- <span id="current-year"></span> Associazione Santa Barbara APS. Tutti i diritti riservati.<br>
        <span style="letter-spacing:2px; font-size:0.95em; color:#222;"><a href="privacy.html" style="color:#e67e22; text-decoration:underline;">PRIVACY POLICY</a> <span style="margin:0 10px;">|</span> <a href="#" style="color:#e67e22; text-decoration:underline;" onclick="window.cookieConsent && window.cookieConsent.open(); return false;">GESTISCI COOKIE</a></span></p>
      </div>
    </div>
  </footer>
  <script src="assets/js/notifications.js"></script> 
  <script src="assets/js/script.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
  <script>

                        // Initialize Supabase
                        const {
                                createClient
                        } = supabase;
                        const supabaseClient = createClient('https://ciezrbsolxpjxswdkkpo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpZXpyYnNvbHhwanhzd2Rra3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjM1NjAsImV4cCI6MjA2ODQ5OTU2MH0.V-U8KhO8byObUW5kJ8XbLBkp9O9Efh98MdbKYFfbQJk');
                        // Global variables (currentUser is already declared in script.js)
                        let userRole = null;
                        // DOM Elements
                        const loadingScreen = document.getElementById('loading-screen');
                        const loginPrompt = document.getElementById('login-prompt');
                        const membersContent = document.getElementById('members-content');
                        const userInfo = document.getElementById('user-info');
                        const logoutBtn = document.getElementById('logout-btn');
                        // Utility Functions
                        function showLoading() {
                                if (loginPrompt) loginPrompt.style.display = 'none';
                                if (membersContent) membersContent.style.display = 'none';
                        }

                        function hideLoading() {
                                // Loading screen removed
                        }

                        function showLoginPrompt() {
                                hideLoading();
                                if (loginPrompt) loginPrompt.style.display = 'block';
                                if (membersContent) membersContent.style.display = 'none';
                        }

  function showMembersContent() {
        hideLoading();
        if (loginPrompt) loginPrompt.style.display = 'none';
        if (membersContent) {
                membersContent.style.display = 'block';
                membersContent.classList.add('show');
        }
        // Mostra tutte le sezioni riservate
        const dashboardSection = document.querySelector('.dashboard-section');
        if (dashboardSection) dashboardSection.style.display = 'block';
        document.querySelectorAll('.col-md-3').forEach(el => el.style.display = 'block');
        const membersEvents = document.querySelector('.members-events');
        if (membersEvents) membersEvents.style.display = 'block';
        const membersDocuments = document.querySelector('.members-documents');
        if (membersDocuments) membersDocuments.style.display = 'block';
  }

                        function updateUserInfo(user, metadata) {
                                if (!userInfo) return;
                                // Estrai informazioni dall'utente e metadata
                                const role = metadata?.role || 'utente';
                                const firstName = metadata?.first_name || '';
                                const lastName = metadata?.last_name || '';
                                const fullName = metadata?.full_name || (firstName && lastName ? `${firstName} ${lastName}` : firstName || lastName || 'Utente');
                                const phoneNumber = metadata?.phone_number || metadata?.phone || '';
                                const dateOfBirth = metadata?.date_of_birth || '';
                                const address = metadata?.address || '';
                                const membershipDate = metadata?.membership_date || '';
                                const membershipNumber = metadata?.membership_number || '';
                                // Calcola giorni dall'ultimo accesso
                                const lastSignIn = new Date(user.last_sign_in_at || user.created_at);
                                const today = new Date();
                                const daysSinceLastAccess = Math.floor((today - lastSignIn) / (1000 * 60 * 60 * 24));
                                // Formatta la data di ultimo accesso
                                const lastAccessText = daysSinceLastAccess === 0 ? 'Oggi' : daysSinceLastAccess === 1 ? 'Ieri' : `${daysSinceLastAccess} giorni fa`;
                                userInfo.innerHTML = `
                                        
                                                                        <div class="user-card">
                                                                                <div class="user-details">
                                                                                        <h3>${fullName}</h3>
                                                                                        <p class="user-email">✉️ ${user.email}</p>
                                                        ${phoneNumber ? `
                                                                                        <p class="user-phone">📞 ${phoneNumber}</p>` : ''}
                                                        
                                                                                        <span class="user-role ${role}">${role === 'socio' ? 'Socio' : 'Utente'}</span>
                                                                                </div>
                                                                        </div>
                                                                        <div class="user-stats">
                                                                                <div class="stat">
                                                                                        <span class="stat-label">Ultimo accesso</span>
                                                                                        <span class="stat-value">${lastAccessText}</span>
                                                                                </div>
                                                                                <div class="stat">
                                                                                        <span class="stat-label">Stato account</span>
                                                                                        <span class="stat-value">✅ Attivo</span>
                                                                                </div>
                                                ${membershipNumber ? `
                                                
                                                                                <div class="stat">
                                                                                        <span class="stat-label">N. Tessera</span>
                                                                                        <span class="stat-value">#${membershipNumber}</span>
                                                                                </div>` : ''}
                                                ${membershipDate ? `
                                                
                                                                                <div class="stat">
                                                                                        <span class="stat-label">Socio dal</span>
                                                                                        <span class="stat-value">${new Date(membershipDate).toLocaleDateString('it-IT')}</span>
                                                                                </div>` : ''}
                                        
                                                                        </div>
                                        ${address || dateOfBirth ? `
                                        
                                                                        <div class="user-additional-info" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                                                ${address ? `
                                                                                <p style="margin-bottom: 10px; opacity: 0.9;">
                                                                                        <strong>📍 Indirizzo:</strong> ${address}
                                                                                </p>` : ''}
                                                ${dateOfBirth ? `
                                                                                <p style="margin-bottom: 10px; opacity: 0.9;">
                                                                                        <strong>🎂 Data di nascita:</strong> ${new Date(dateOfBirth).toLocaleDateString('it-IT')}
                                                                                </p>` : ''}
                                        
                                                                        </div>` : ''}
                                `;
                        }
                        // Authentication Functions
                        async function checkAuthentication() {
                                showLoading();
                                try {
                                        // Get current session
                                        const {
                                                data: {
                                                        session
                                                },
                                                error
                                        } = await supabaseClient.auth.getSession();
                                        if (error) {
                                                console.error('Error checking session:', error);
                                                showLoginPrompt();
                                                return;
                                        }
                                        if (!session || !session.user) {
                                                // No active session, redirect to login
                                                setTimeout(() => {
                                                        window.location.href = 'login.html';
                                                }, 1000);
                                                return;
                                        }
                                        // Check if email is confirmed
                                        if (!session.user.email_confirmed_at) {
                                                showLoginPrompt();
                                                if (loginPrompt) {
                                                        loginPrompt.innerHTML = `
                                                        
                        
                        
                                                                        <div class="auth-prompt">
                                                                                <h2>⚠️ Email non confermata</h2>
                                                                                <p>Il tuo account non è ancora stato confermato.</p>
                                                                                <p>Controlla la tua casella di posta e clicca sul link di conferma.</p>
                                                                                <div class="auth-actions">
                                                                                        <button onclick="resendConfirmation()" class="btn btn-primary">Invia di nuovo email</button>
                                                                                        <a href="login.html" class="btn btn-secondary">Torna al Login</a>
                                                                                </div>
                                                                        </div>
                                                `;
                                                }
                                                return;
                                        }
                                        // User is authenticated and confirmed
                                        currentUser = session.user;
                                        let userMetadata = session.user.user_metadata;
                                        userRole = userMetadata?.role || 'utente';
                                        // Try to fetch additional user profile data from profiles table
                                        try {
  const {
        data: profileData,
        error: profileError
  } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
                                                if (!profileError && profileData) {
                                                        // Merge profile data with user metadata
                                                        userMetadata = {
                                                                ...userMetadata,
                                                                ...profileData
                                                        };
                                                        userRole = profileData.role || userMetadata?.role || 'utente';
                                                }
                                        } catch (profileError) {
                                                // Continue with just the metadata from auth
                                        }
                                        // Check if user has access (socio role)
                                        if (userRole !== 'socio') {
                                                showLoginPrompt();
                                                if (loginPrompt) {
                                                        loginPrompt.innerHTML = `
                                                        
                        
                        
                                                                        <div class="auth-prompt">
                                                                                <h2>🔒 Accesso Limitato</h2>
                                                                                <p>Il tuo account è attivo ma non hai i permessi per accedere all'area soci.</p>
                                                                                <p>Contatta l'amministrazione per richiedere l'attivazione come socio.</p>
                                                                                <div class="contact-info">
                                                                                        <p>📧 
                                                
                                                
                                                                                                <strong>Email:</strong> info@associazionesbarbara.it
                                        
                                        
                                                                                        </p>
                                                                                        <p>📍 
                                                
                                                
                                                                                                <strong>Sede:</strong> Via N. Mastroserio 12, Grumo Appula (BA)
                                        
                                        
                                                                                        </p>
                                                                                </div>
                                                                                <div class="auth-actions">
                                                                                        <button onclick="handleLogout()" class="btn btn-secondary">Logout</button>
                                                                                        <a href="index.html" class="btn btn-primary">Torna alla Home</a>
                                                                                </div>
                                                                        </div>
                                                `;
                                                }
                                                return;
                                        }
                                        // User has access, show members content
                                        updateUserInfo(currentUser, userMetadata);
                                        showMembersContent();
                                } catch (error) {
                                        console.error('Authentication check failed:', error);
                                        showLoginPrompt();
                                }
                        }
                        // Resend confirmation email
                        async function resendConfirmation() {
                                try {
                                        const {
                                                error
                                        } = await supabaseClient.auth.resend({
                                                type: 'signup',
                                                email: currentUser?.email
                                        });
                                        if (error) {
                                                notify.error('Errore nell\'invio dell\'email: ' + error.message);
                                        } else {
                                                notify.success('Email di conferma inviata! Controlla la tua casella di posta.');
                                        }
                                } catch (error) {
                                        console.error('Error resending confirmation:', error);
                                        notify.error('Errore nell\'invio dell\'email di conferma.');
                                }
                        }
                        // Logout function
                        async function handleLogout() {
                                try {
                                        const {
                                                error
                                        } = await supabaseClient.auth.signOut();
                                        if (error) {
                                                console.error('Logout error:', error);
                                                notify.error('Errore durante il logout: ' + error.message);
                                        } else {
                                                notify.info('Logout effettuato con successo. Arrivederci!');
                                                // Redirect to home page after successful logout
                                                setTimeout(() => {
                                                        window.location.href = 'index.html';
                                                }, 1000);
                                        }
                                } catch (error) {
                                        console.error('Logout failed:', error);
                                        notify.error('Errore durante il logout.');
                                }
                        }
                        // Auth state change listener
                        supabaseClient.auth.onAuthStateChange((event, session) => {
                                if (event === 'SIGNED_OUT' || !session) {
                                        // User signed out or session expired
                                        window.location.href = 'login.html';
                                } else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                                        // User signed in or token refreshed
                                        checkAuthentication();
                                }
                        });
                        // Profile Management Functions

                        function hideAllForms() {
                                const editForm = document.getElementById('profile-edit-form');
                                const passwordForm = document.getElementById('password-change-form');
                                const emailForm = document.getElementById('email-change-form');
                                if (editForm) editForm.style.display = 'none';
                                if (passwordForm) passwordForm.style.display = 'none';
                                if (emailForm) emailForm.style.display = 'none';
                                // Rimuovi stato attivo da tutti i pulsanti
                                document.getElementById('edit-profile-btn')?.classList.remove('btn-active');
                                document.getElementById('change-password-btn')?.classList.remove('btn-active');
                                document.getElementById('change-email-btn')?.classList.remove('btn-active');
                        }

                        function showEditProfile() {
                                hideAllForms();
                                const editForm = document.getElementById('profile-edit-form');
                                const btn = document.getElementById('edit-profile-btn');
                                if (editForm) {
                                        editForm.style.display = 'block';
                                        populateEditForm();
                                }
                                if (btn) btn.classList.add('btn-active');
                        }

                        function hideEditProfile() {
                                const editForm = document.getElementById('profile-edit-form');
                                if (editForm) editForm.style.display = 'none';
                        }

                        function showChangePassword() {
                                hideAllForms();
                                const passwordForm = document.getElementById('password-change-form');
                                const btn = document.getElementById('change-password-btn');
                                if (passwordForm) passwordForm.style.display = 'block';
                                if (btn) btn.classList.add('btn-active');
                        }

                        function hideChangePassword() {
                                const passwordForm = document.getElementById('password-change-form');
                                if (passwordForm) passwordForm.style.display = 'none';
                        }

                        function showChangeEmail() {
                                hideAllForms();
                                const emailForm = document.getElementById('email-change-form');
                                const btn = document.getElementById('change-email-btn');
                                if (emailForm) emailForm.style.display = 'block';
                                if (btn) btn.classList.add('btn-active');
                        }
                        
                        function populateEditForm() {
                                if (!currentUser) return;
                                // Usa user_metadata già merge-ato con i dati del profilo (come fatto in checkAuthentication)
                                const metadata = currentUser.user_metadata || {};
                                // Informazioni Personali
                                document.getElementById('edit-firstName').value = metadata.first_name || '';
                                document.getElementById('edit-lastName').value = metadata.last_name || '';
                                document.getElementById('edit-dateOfBirth').value = metadata.date_of_birth || '';
                                document.getElementById('edit-placeOfBirth').value = metadata.place_of_birth || '';
                                document.getElementById('edit-gender').value = metadata.gender || '';
                                document.getElementById('edit-fiscalCode').value = metadata.fiscal_code || '';
                                // Contatti
                                document.getElementById('edit-phone').value = metadata.phone_number || metadata.phone || '';
                                // Indirizzo
                                document.getElementById('edit-address').value = metadata.address || '';
                                document.getElementById('edit-city').value = metadata.city || '';
                                document.getElementById('edit-zipCode').value = metadata.zip_code || '';
                                document.getElementById('edit-province').value = metadata.province || '';
                        }
                        
                        async function handleProfileUpdate(event) {
                                event.preventDefault();
                                
                                const submitBtn = event.target.querySelector('button[type="submit"]');
                                const originalText = submitBtn.innerHTML;
                                
                                // Show loading state
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '⏳ Salvando...';
                                
                                const formData = new FormData(event.target);
                                
                                // Validate fiscal code format if provided
                                const fiscalCode = formData.get('fiscalCode')?.toUpperCase().trim();
                                if (fiscalCode && !/^[A-Z0-9]{16}$/.test(fiscalCode)) {
                                        notify.error('Il codice fiscale deve essere di 16 caratteri alfanumerici');
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = originalText;
                                        return;
                                }
                                
                                // Validate ZIP code format if provided
                                const zipCode = formData.get('zipCode');
                                if (zipCode && !/^\d{5}$/.test(zipCode)) {
                                        notify.error('Il CAP deve essere di 5 cifre');
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = originalText;
                                        return;
                                }
                                
                                // Validate province format if provided
                                const province = formData.get('province')?.toUpperCase().trim();
                                if (province && !/^[A-Z]{2}$/.test(province)) {
                                        notify.error('La provincia deve essere di 2 lettere maiuscole');
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = originalText;
                                        return;
                                }
                                
                                const updateData = {
                                        // Informazioni Personali
                                        first_name: formData.get('firstName'),
                                        last_name: formData.get('lastName'),
                                        date_of_birth: formData.get('dateOfBirth') || null,
                                        place_of_birth: formData.get('placeOfBirth') || null,
                                        gender: formData.get('gender') || null,
                                        fiscal_code: fiscalCode || null,
                                        
                                        // Contatti
                                        phone_number: formData.get('phone') || null,
                                        phone: formData.get('phone') || null, // Keep both for compatibility
                                        
                                        // Indirizzo
                                        address: formData.get('address') || null,
                                        city: formData.get('city') || null,
                                        zip_code: zipCode || null,
                                        province: province || null,
                                        
                                };
                                
                                try {
                                        // Update user metadata in Supabase Auth
                                        const { error: authError } = await supabaseClient.auth.updateUser({
                                                data: updateData
                                        });
                                        
                                        if (authError) throw authError;
                                        
                                        // Also try to update profiles table if it exists
                                        try {
                                                const profileUpdateData = {
                                                        first_name: updateData.first_name,
                                                        last_name: updateData.last_name,
                                                        date_of_birth: updateData.date_of_birth,
                                                        place_of_birth: updateData.place_of_birth,
                                                        gender: updateData.gender,
                                                        fiscal_code: updateData.fiscal_code,
                                                        phone: updateData.phone_number,
                                                        address: updateData.address,
                                                        city: updateData.city,
                                                        zip_code: updateData.zip_code,
                                                        province: updateData.province,
                                                        updated_at: new Date().toISOString()
                                                };
                                                
                                                const { error: profileError } = await supabaseClient
                                                        .from('profiles')
                                                        .update(profileUpdateData)
                                                        .eq('id', currentUser.id);
                                                        
                                                if (profileError) {
                                                        console.warn('Profile table update failed:', profileError);
                                                        // Don't throw error - auth update succeeded
                                                }
                                        } catch (profileError) {
                                                console.warn('Profiles table not accessible:', profileError);
                                                // Continue - auth metadata update succeeded
                                        }
                                        
                                        notify.success('Profilo aggiornato con successo!');
                                        hideEditProfile();
                                        // Refresh user info
                                        checkAuthentication();
                                        
                                } catch (error) {
                                        console.error('Profile update error:', error);
                                        notify.error('Errore durante l\'aggiornamento del profilo: ' + error.message);
                                } finally {
                                        // Reset button state
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = originalText;
                                }
                        }
                        
                        async function handlePasswordChange(event) {
                                event.preventDefault();
                                
                                const submitBtn = event.target.querySelector('button[type="submit"]');
                                const originalText = submitBtn.innerHTML;
                                
                                const formData = new FormData(event.target);
                                const currentPassword = formData.get('currentPassword');
                                const newPassword = formData.get('newPassword');
                                const confirmPassword = formData.get('confirmPassword');
                                
                                // Validate passwords match
                                if (newPassword !== confirmPassword) {
                                        notify.error('Le password non coincidono');
                                        return;
                                }
                                
                                // Validate password length
                                if (newPassword.length < 6) {
                                        notify.error('La password deve essere lunga almeno 6 caratteri');
                                        return;
                                }
                                
                                // Show loading state
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '⏳ Cambiando...';
                                
                                try {
                                        const { error } = await supabaseClient.auth.updateUser({
                                                password: newPassword
                                        });
                                        
                                        if (error) throw error;
                                        
                                        notify.success('Password cambiata con successo!');
                                        hideChangePassword();
                                        
                                        // Clear form
                                        document.getElementById('update-password-form').reset();
                                        
                                } catch (error) {
                                        console.error('Password change error:', error);
                                        notify.error('Errore durante il cambio password: ' + error.message);
                                } finally {
                                        // Reset button state
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = originalText;
                                }
                        }

                        // Event Listeners
                        document.addEventListener('DOMContentLoaded', function() {
                                // Add logout button event listener
                                if (logoutBtn) {
                                        logoutBtn.addEventListener('click', handleLogout);
                                }
                                
                                // Profile management buttons
                                const editProfileBtn = document.getElementById('edit-profile-btn');
                                const changePasswordBtn = document.getElementById('change-password-btn');
                                const cancelEditBtn = document.getElementById('cancel-edit-btn');
                                const cancelPasswordBtn = document.getElementById('cancel-password-btn');
                                const updateProfileForm = document.getElementById('update-profile-form');
                                const updatePasswordForm = document.getElementById('update-password-form');
                                
                                if (editProfileBtn) {
                                        editProfileBtn.addEventListener('click', showEditProfile);
                                }
                                if (changePasswordBtn) {
                                        changePasswordBtn.addEventListener('click', showChangePassword);
                                }
                                const changeEmailBtn = document.getElementById('change-email-btn');
                                if (changeEmailBtn) {
                                        changeEmailBtn.addEventListener('click', showChangeEmail);
                                }
                                if (cancelEditBtn) {
                                        cancelEditBtn.addEventListener('click', hideEditProfile);
                                }
                                if (cancelPasswordBtn) {
                                        cancelPasswordBtn.addEventListener('click', hideChangePassword);
                                }
                                if (updateProfileForm) {
                                        updateProfileForm.addEventListener('submit', handleProfileUpdate);
                                }
                                if (updatePasswordForm) {
                                        updatePasswordForm.addEventListener('submit', handlePasswordChange);
                                }
                                
                                // Check authentication on page load
                                checkAuthentication();
                                
                                // Events management initialization
                                initializeEventsManagement();
                        });
                        
                        // Events Management Functions
                        let allUsers = [];
                        let currentEditingEventId = null;
                        
                        async function initializeEventsManagement() {
                                // Load users for the dropdown
                                await loadUsers();
                                
                                // Setup event listeners for events management
                                setupEventsEventListeners();
                                
                                // Load events list
                                await loadEventsList();
                        }
                        
                        async function loadUsers() {
                                try {
                                        // Try to load from profiles table first
                                        let { data: profiles, error: profilesError } = await supabaseClient
                                                .from('profiles')
                                                .select('id, first_name, last_name, email');
                                        
                                        if (profilesError) {
                                                console.warn('Cannot access profiles table:', profilesError);
                                                // Fallback: use auth metadata if available
                                                allUsers = [];
                                                return;
                                        }
                                        
                                        allUsers = profiles || [];
                                        populateUsersDropdown();
                                        
                                } catch (error) {
                                        console.error('Error loading users:', error);
                                        allUsers = [];
                                }
                        }
                        
                        function populateUsersDropdown() {
                                const dropdown = document.getElementById('event-created-by');
                                if (!dropdown) return;
                                
                                // Clear existing options except the first one
                                while (dropdown.children.length > 1) {
                                        dropdown.removeChild(dropdown.lastChild);
                                }
                                
                                // Add current user as default
                                if (currentUser) {
                                        const currentUserOption = document.createElement('option');
                                        currentUserOption.value = currentUser.id;
                                        currentUserOption.textContent = getUserDisplayName(currentUser);
                                        currentUserOption.selected = true;
                                        dropdown.appendChild(currentUserOption);
                                }
                                
                                // Add other users
                                allUsers.forEach(user => {
                                        if (user.id !== currentUser?.id) {
                                                const option = document.createElement('option');
                                                option.value = user.id;
                                                option.textContent = getUserDisplayName(user);
                                                dropdown.appendChild(option);
                                        }
                                });
                        }
                        
                        function getUserDisplayName(user) {
                                if (user.first_name && user.last_name) {
                                        return `${user.first_name} ${user.last_name}`;
                                }
                                if (user.first_name) return user.first_name;
                                if (user.last_name) return user.last_name;
                                return user.email || 'Utente senza nome';
                        }
                        
                        function setupEventsEventListeners() {
                                // Tab switching
                                const showEventsListBtn = document.getElementById('show-events-list');
                                const showCreateEventBtn = document.getElementById('show-create-event');
                                
                                if (showEventsListBtn) {
                                        showEventsListBtn.addEventListener('click', () => switchToEventsTab('list'));
                                }
                                if (showCreateEventBtn) {
                                        showCreateEventBtn.addEventListener('click', () => switchToEventsTab('form'));
                                }
                                
                                // Form handling
                                const eventForm = document.getElementById('event-management-form');
                                const cancelFormBtn = document.getElementById('cancel-event-form');
                                const deleteEventBtn = document.getElementById('delete-event-btn');
                                
                                if (eventForm) {
                                        eventForm.addEventListener('submit', handleEventSubmit);
                                }
                                if (cancelFormBtn) {
                                        cancelFormBtn.addEventListener('click', cancelEventForm);
                                }
                                if (deleteEventBtn) {
                                        deleteEventBtn.addEventListener('click', handleEventDelete);
                                }
                        }
                        
                        function switchToEventsTab(tab) {
                                const listSection = document.getElementById('events-list-section');
                                const formSection = document.getElementById('event-form-section');
                                const listBtn = document.getElementById('show-events-list');
                                const formBtn = document.getElementById('show-create-event');
                                
                                if (tab === 'list') {
                                        listSection.style.display = 'block';
                                        formSection.style.display = 'none';
                                        listBtn.classList.add('active-tab');
                                        listBtn.classList.remove('btn-outline');
                                        listBtn.classList.add('btn-primary');
                                        formBtn.classList.remove('active-tab');
                                        formBtn.classList.add('btn-outline');
                                        formBtn.classList.remove('btn-primary');
                                } else {
                                        listSection.style.display = 'none';
                                        formSection.style.display = 'block';
                                        formBtn.classList.add('active-tab');
                                        formBtn.classList.remove('btn-outline');
                                        formBtn.classList.add('btn-primary');
                                        listBtn.classList.remove('active-tab');
                                        listBtn.classList.add('btn-outline');
                                        listBtn.classList.remove('btn-primary');
                                        
                                        // Reset form for new event
                                        if (!currentEditingEventId) {
                                                resetEventForm();
                                        }
                                }
                        }
                        
                        async function loadEventsList() {
                                try {
                                        const { data: events, error } = await supabaseClient
                                                .from('events')
                                                .select('*')
                                                .order('event_date', { ascending: false });
                                        
                                        if (error) throw error;
                                        
                                        renderEventsTable(events || []);
                                        
                                } catch (error) {
                                        console.error('Error loading events:', error);
                                        notify.error('Errore nel caricamento degli eventi: ' + error.message);
                                }
                        }
                        
                        function renderEventsTable(events) {
                                const tbody = document.getElementById('admin-events-tbody');
                                const noEventsMessage = document.getElementById('no-events-message');
                                
                                if (!tbody) {
                                        console.error('Table tbody not found!');
                                        return;
                                }
                                
                                if (events.length === 0) {
                                        tbody.innerHTML = '';
                                        if (noEventsMessage) noEventsMessage.style.display = 'block';
                                        return;
                                }
                                
                                if (noEventsMessage) noEventsMessage.style.display = 'none';
                                
                                tbody.innerHTML = events.map(event => `
                                        <tr style="border-bottom: 1px solid #ddd;">
                                                <td class="event-title" style="padding: 12px; border: 1px solid #ddd; font-weight: 600; color: #e10600; word-wrap: break-word; max-width: 250px;">${escapeHtml(event.title || '')}</td>
                                                <td class="event-date" style="padding: 12px; border: 1px solid #ddd; white-space: nowrap; text-align: center; color: #333; font-weight: 500;">${formatDate(event.event_date)}</td>
                                                <td style="padding: 12px; border: 1px solid #ddd; word-wrap: break-word; max-width: 200px; text-align: center;">${escapeHtml(event.location || '-')}</td>
                                                <td class="event-public" style="padding: 12px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">${event.is_public ? '✅ Sì' : '❌ No'}</td>
                                                <td class="event-actions" style="padding: 8px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">
                                                        <button onclick="editEvent('${event.id}')" class="btn-sm btn-edit" style="padding: 6px 12px; margin-right: 8px; margin-bottom: 0; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: inline-block;">✏️ Modifica</button>
                                                        <button onclick="deleteEvent('${event.id}')" class="btn-sm btn-delete" style="padding: 6px 12px; margin-bottom: 0; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: inline-block;">🗑️ Elimina</button>
                                                </td>
                                        </tr>
                                `).join('');
                        }
                        
                        function formatDate(dateString) {
                                if (!dateString || dateString === null || dateString === undefined) {
                                        return '-';
                                }
                                try {
                                        // Gestione formato ISO (YYYY-MM-DD)
                                        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                                                const [year, month, day] = dateString.split('-');
                                                return `${day}/${month}/${year}`;
                                        }
                                        // Gestione formato con orario (YYYY-MM-DDTHH:mm:ss)
                                        if (/^\d{4}-\d{2}-\d{2}T/.test(dateString)) {
                                                const date = new Date(dateString);
                                                if (!isNaN(date.getTime())) {
                                                        return date.toLocaleDateString('it-IT');
                                                }
                                        }
                                        // Fallback generico
                                        const date = new Date(dateString);
                                        if (!isNaN(date.getTime())) {
                                                return date.toLocaleDateString('it-IT');
                                        }
                                        return dateString;
                                } catch (error) {
                                        return dateString || '-';
                                }
                        }
                        
                        function getStatusLabel(status) {
                                return '';
                        }
                        
                        function escapeHtml(text) {
                                const div = document.createElement('div');
                                div.textContent = text;
                                return div.innerHTML;
                        }
                        
                        function resetEventForm() {
                                const form = document.getElementById('event-management-form');
                                const title = document.getElementById('event-form-title');
                                const deleteBtn = document.getElementById('delete-event-btn');
                                
                                if (form) form.reset();
                                if (title) title.textContent = '➕ Nuovo Evento';
                                if (deleteBtn) deleteBtn.style.display = 'none';
                                
                                currentEditingEventId = null;
                                
                                // Set default values
                                const isPublicCheckbox = document.getElementById('event-is-public');
                                const createdBySelect = document.getElementById('event-created-by');
                                
                                if (isPublicCheckbox) isPublicCheckbox.checked = true;
                                if (createdBySelect && currentUser) createdBySelect.value = currentUser.id;
                        }
                        
                        function cancelEventForm() {
                                resetEventForm();
                                switchToEventsTab('list');
                        }
                        
                        async function handleEventSubmit(event) {
                                event.preventDefault();
                                
                                const submitBtn = document.getElementById('save-event-btn');
                                const originalText = submitBtn.innerHTML;
                                
                                // Show loading state
                                submitBtn.disabled = true;
                                submitBtn.innerHTML = '⏳ Salvando...';
                                
                                try {
                                        const formData = new FormData(event.target);
                                        
                                        // Validation
                                        if (!formData.get('title')?.trim()) {
                                                throw new Error('Il titolo è obbligatorio');
                                        }
                                        if (!formData.get('event_date')) {
                                                throw new Error('La data è obbligatoria');
                                        }
                                        
                                        const eventData = {
                                                title: formData.get('title').trim(),
                                                description: formData.get('description')?.trim() || null,
                                                content: formData.get('content')?.trim() || null,
                                                event_date: formData.get('event_date'),
                                                event_time: formData.get('event_time')?.trim() || null,
                                                location: formData.get('location')?.trim() || null,
                                                address: formData.get('address')?.trim() || null,
                                                image_url: formData.get('image_url')?.trim() || null,
                                                created_by: formData.get('created_by') || currentUser?.id,
                                                is_public: formData.get('is_public') === 'on',
                                                updated_at: new Date().toISOString()
                                        };
                                        
                                        let result;
                                        if (currentEditingEventId) {
                                                // Update existing event
                                                result = await supabaseClient
                                                        .from('events')
                                                        .update(eventData)
                                                        .eq('id', currentEditingEventId);
                                        } else {
                                                // Create new event
                                                eventData.created_at = new Date().toISOString();
                                                result = await supabaseClient
                                                        .from('events')
                                                        .insert([eventData]);
                                        }
                                        
                                        if (result.error) throw result.error;
                                        
                                        notify.success(currentEditingEventId ? 'Evento aggiornato con successo!' : 'Evento creato con successo!');
                                        
                                        // Refresh events list and switch to list view
                                        await loadEventsList();
                                        switchToEventsTab('list');
                                        
                                } catch (error) {
                                        console.error('Error saving event:', error);
                                        notify.error('Errore nel salvataggio: ' + error.message);
                                } finally {
                                        // Reset button state
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = originalText;
                                }
                        }
                        
                        async function editEvent(eventId) {
                                try {
                                        const { data: event, error } = await supabaseClient
                                                .from('events')
                                                .select('*')
                                                .eq('id', eventId)
                                                .single();
                                        
                                        if (error) throw error;
                                        
                                        // Populate form with event data
                                        currentEditingEventId = eventId;
                                        populateEventForm(event);
                                        
                                        // Switch to form view
                                        switchToEventsTab('form');
                                        
                                        // Update form title and show delete button
                                        const title = document.getElementById('event-form-title');
                                        const deleteBtn = document.getElementById('delete-event-btn');
                                        
                                        if (title) title.textContent = '✏️ Modifica Evento';
                                        if (deleteBtn) deleteBtn.style.display = 'inline-block';
                                        
                                } catch (error) {
                                        console.error('Error loading event for edit:', error);
                                        notify.error('Errore nel caricamento dell\'evento: ' + error.message);
                                }
                        }
                        
                        function populateEventForm(event) {
                                document.getElementById('event-id').value = event.id || '';
                                document.getElementById('event-title').value = event.title || '';
                                document.getElementById('event-description').value = event.description || '';
                                document.getElementById('event-content').value = event.content || '';
                                document.getElementById('event-date').value = event.event_date || '';
                                document.getElementById('event-time').value = event.event_time || '';
                                document.getElementById('event-location').value = event.location || '';
                                document.getElementById('event-address').value = event.address || '';
                                document.getElementById('event-image-url').value = event.image_url || '';
                                document.getElementById('event-created-by').value = event.created_by || '';
                                document.getElementById('event-is-public').checked = event.is_public !== false;
                        }
                        
                        async function deleteEvent(eventId) {
                                if (!confirm('Sei sicuro di voler eliminare questo evento? Questa azione non può essere annullata.')) {
                                        return;
                                }
                                
                                try {
                                        const { error } = await supabaseClient
                                                .from('events')
                                                .delete()
                                                .eq('id', eventId);
                                        
                                        if (error) throw error;
                                        
                                        notify.success('Evento eliminato con successo!');
                                        await loadEventsList();
                                        
                                        // If we were editing this event, switch back to list
                                        if (currentEditingEventId === eventId) {
                                                switchToEventsTab('list');
                                        }
                                        
                                } catch (error) {
                                        console.error('Error deleting event:', error);
                                        notify.error('Errore nell\'eliminazione: ' + error.message);
                                }
                        }
                        
                        async function handleEventDelete() {
                                if (currentEditingEventId) {
                                        await deleteEvent(currentEditingEventId);
                                }
                        }
                        
                        // Make functions globally available for onclick handlers
                        window.editEvent = editEvent;
                        window.deleteEvent = deleteEvent;
                        
                        // Global functions for buttons
                        window.resendConfirmation = resendConfirmation;
                        window.handleLogout = handleLogout;
  </script> 
  <script src="assets/js/adblock-detector-v2.js"></script> 
  <script src="assets/js/adblock-integration-v2.js"></script>
</body>
</html>
