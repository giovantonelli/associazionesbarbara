<!DOCTYPE html>
<html lang="it">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Area Soci - Associazione Santa Barbara APS</title>
		<meta name="description" content="Accesso riservato ai soci dell'Associazione Santa Barbara APS">
		<meta name="keywords" content="area soci, login, accesso riservato, associazione">
		<link rel="stylesheet" href="assets/css/style.css">
		<link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
		<!-- Google tag (gtag.js) with Consent Mode -->
		<script>
			// Define dataLayer and the gtag function
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			// Set default consent to 'denied' as a placeholder for EU users
			gtag('consent', 'default', {
				'ad_storage': 'denied',
				'ad_user_data': 'denied',
				'ad_personalization': 'denied',
				'analytics_storage': 'denied',
				'wait_for_update': 500
			});
		</script>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-F465WJF33T"></script>
		<script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());
			gtag('config', 'G-F465WJF33T');
		</script>
	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar">
			<div class="container">
				<div class="nav-brand">
					<a href="index.html" class="nav-brand-link">
						<img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="logo">
						<span class="brand-text">Associazione Santa Barbara APS</span>
					</a>
				</div>
				<button class="nav-toggle" aria-label="Toggle navigation">
					<span></span>
					<span></span>
					<span></span>
				</button>
				<ul class="nav-menu">
					<li>
						<a href="index.html" class="nav-link">Home</a>
					</li>
					<li>
						<a href="chi-siamo.html" class="nav-link">Chi siamo</a>
					</li>
					<li>
						<a href="attivita.html" class="nav-link">Attivit√†</a>
					</li>
					<li>
						<a href="eventi.html" class="nav-link">Eventi</a>
					</li>
					<li>
						<a href="galleria.html" class="nav-link">Galleria</a>
					</li>
					<li>
						<a href="faq.html" class="nav-link">FAQ</a>
					</li>
					<li>
						<a href="contatti.html" class="nav-link">Contatti</a>
					</li>
					<li>
						<a href="partner.html" class="nav-link">Partner</a>
					</li>
					<li>
						<a id="logout-btn" class="btn btn-secondary">üö™ Logout</a>
					</li>
				</ul>
			</div>
		</nav>
		<!-- Page Header -->
		<section class="page-header">
			<div class="container">
				<h1>Area Soci</h1>
				<p>Accesso riservato ai soci dell'associazione</p>
			</div>
		</section>
		<!-- Loading screen base -->
		<div id="loading-screen" class="loading-screen">
			<div class="loading-content">
				<div class="loading-spinner"></div>
				<h3>Caricamento in corso <span class="loading-dots"></span>
				</h3>
				<p>Attendere prego</p>
			</div>
		</div>
		<!-- Login Prompt Section -->
		<div id="login-prompt" style="display: none; padding: 60px 0; text-align: center;">
			<div class="container">
				<!-- Content will be dynamically inserted by JavaScript -->
			</div>
		</div>
		<!-- Cookie Banner: sempre visibile -->
		<div id="cookieBanner" class="cookie-banner">
			<div class="cookie-content">
				<p>Questo sito utilizza cookie per migliorare l'esperienza di navigazione. Continuando a navigare accetti l'uso dei cookie.</p>
				<div class="cookie-buttons">
					<button id="acceptCookies" class="btn btn-primary">Accetta</button>
					<button id="rejectCookies" class="btn btn-secondary">Rifiuta</button>
					<a href="privacy.html" class="btn btn-link">Privacy Policy</a>
				</div>
			</div>
		</div>

		<!-- Members Content (solo per soci) -->
		<section id="members-content" class="members-content" style="display:none;">
			<div class="container">
				<!-- User Info Section -->
				<div id="user-info" class="user-info">
					<!-- User info will be populated by JavaScript -->
				</div>
				
				<!-- Gestione Profilo -->
				<div class="content-section" style="margin-top: 30px;">
					<h3>‚öôÔ∏è Gestione Profilo</h3>
					<p>Gestisci i tuoi dati e le preferenze dell'account</p>
					<div class="profile-management">
						<div class="profile-actions">
							<button id="edit-profile-btn" class="btn btn-outline">‚úèÔ∏è Modifica Profilo</button>
					<button id="change-password-btn" class="btn btn-outline">üîë Cambia Password</button>
					<button id="change-email-btn" class="btn btn-outline">‚úâÔ∏è Cambia Email</button>
						</div>
					</div>
				</div>
				
				<!-- Profile Edit Form (initially hidden) -->
				<div id="profile-edit-form" class="content-section" style="display: none; margin-top: 20px;">
					<h3>‚úèÔ∏è Modifica Profilo</h3>
					<form id="update-profile-form">
						<div class="form-grid">
							<!-- Informazioni Personali -->
							<div class="form-group">
								<label for="edit-firstName">Nome *</label>
								<input type="text" id="edit-firstName" name="firstName" required>
							</div>
							<div class="form-group">
								<label for="edit-lastName">Cognome *</label>
								<input type="text" id="edit-lastName" name="lastName" required>
							</div>
							<div class="form-group">
								<label for="edit-dateOfBirth">Data di Nascita</label>
								<input type="date" id="edit-dateOfBirth" name="dateOfBirth">
							</div>
							<div class="form-group">
								<label for="edit-placeOfBirth">Luogo di Nascita</label>
								<input type="text" id="edit-placeOfBirth" name="placeOfBirth">
							</div>
							<div class="form-group">
								<label for="edit-gender">Sesso *</label>
<select id="edit-gender" name="gender" required class="form-input">
									<option value="">Seleziona...</option>
									<option value="M">Maschio</option>
									<option value="F">Femmina</option>
								</select>
							</div>
							<div class="form-group">
								<label for="edit-fiscalCode">Codice Fiscale</label>
								<input type="text" id="edit-fiscalCode" name="fiscalCode" pattern="[A-Z0-9]{16}" title="16 caratteri alfanumerici" style="text-transform: uppercase;">
							</div>
							
							<!-- Contatti -->
							<div class="form-group">
								<label for="edit-phone">Telefono</label>
								<input type="tel" id="edit-phone" name="phone">
							</div>
							
							<!-- Indirizzo -->
							<div class="form-group">
								<label for="edit-address">Indirizzo</label>
								<input type="text" id="edit-address" name="address">
							</div>
							<div class="form-group">
								<label for="edit-city">Citt√†</label>
								<input type="text" id="edit-city" name="city">
							</div>
							<div class="form-group">
								<label for="edit-zipCode">CAP</label>
								<input type="text" id="edit-zipCode" name="zipCode" pattern="[0-9]{5}" title="5 cifre" maxlength="5">
							</div>
							<div class="form-group">
								<label for="edit-province">Provincia</label>
								<input type="text" id="edit-province" name="province" pattern="[A-Z]{2}" title="2 lettere maiuscole" maxlength="2" style="text-transform: uppercase;">
							</div>
							
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-primary">üíæ Salva Modifiche</button>
							<button type="button" id="cancel-edit-btn" class="btn btn-secondary">‚ùå Annulla</button>
						</div>
					</form>
				</div>
				
				<!-- Change Password Form (initially hidden) -->
				<div id="password-change-form" class="content-section" style="display: none; margin-top: 20px;">
					<h3>üîë Cambia Password</h3>
					<form id="update-password-form">
						<div class="form-group">
							<label for="current-password">Password Attuale *</label>
							<input type="password" id="current-password" name="currentPassword" required>
						</div>
						<div class="form-group">
							<label for="new-password">Nuova Password *</label>
							<input type="password" id="new-password" name="newPassword" required minlength="6">
						</div>
						<div class="form-group">
							<label for="confirm-password">Conferma Nuova Password *</label>
							<input type="password" id="confirm-password" name="confirmPassword" required minlength="6">
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-primary">üîë Cambia Password</button>
							<button type="button" id="cancel-password-btn" class="btn btn-secondary">‚ùå Annulla</button>
						</div>
					</form>
				</div>

				<!-- Change Email Form (initially hidden) -->
				<div id="email-change-form" class="content-section" style="display: none; margin-top: 20px;">
					<h3>‚úâÔ∏è Cambia Email</h3>
					<form id="update-email-form">
						<div class="form-group">
							<label for="current-email">Email Attuale</label>
							<input type="email" id="current-email" name="currentEmail" readonly>
						</div>
						<div class="form-group">
							<label for="new-email">Nuova Email *</label>
							<input type="email" id="new-email" name="newEmail" required>
						</div>
						<div class="form-group">
							<label for="confirm-new-email">Conferma Nuova Email *</label>
							<input type="email" id="confirm-new-email" name="confirmNewEmail" required>
						</div>
						<div class="form-actions">
						<button type="submit" class="btn btn-primary">‚úâÔ∏è Cambia Email</button>
						<button type="button" id="cancel-email-btn" class="btn btn-secondary">‚ùå Annulla</button>
					</div>
					</form>
				</div>
			</div>
		</section>
		<footer class="footer">
			<div class="container">
				<div class="footer-content">
					<div class="footer-section">
						<img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="footer-logo">
						<p>Associazione Santa Barbara APS</p>
						<p>Promuoviamo la cultura e il volontariato nel nostro territorio</p>
					</div>
					<div class="footer-section">
						<h4>Link utili</h4>
						<ul>
							<li>
								<a href="chi-siamo.html">Chi siamo</a>
							</li>
							<li>
								<a href="attivita.html">Attivit√†</a>
							</li>
							<li>
								<a href="eventi.html">Eventi</a>
							</li>
							<li>
								<a href="contatti.html">Contatti</a>
							</li>
						</ul>
					</div>
					<div class="footer-section">
						<h4>Informazioni</h4>
						<ul>
							<li>
								<a href="privacy.html">Privacy Policy</a>
							</li>
							<li>
								<a href="faq.html">FAQ</a>
							</li>
							<li>
								<a href="area-soci.html">Area Soci</a>
							</li>
						</ul>
					</div>
					<div class="footer-section">
						<h4>Seguici</h4>
						<div class="social-links">
							<a href="https://www.facebook.com/santabarbara.grumoappula" class="social-link" aria-label="Facebook">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
									<path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
								</svg>
							</a>
							<a href="https://www.instagram.com/corteostoricosantabarbara/" class="social-link" aria-label="Instagram">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
									<path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
								</svg>
							</a>
							<a href="https://t.me/associazionesbarbara" class="social-link" aria-label="Telegram">
								<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
									<path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" />
								</svg>
							</a>
						</div>
					</div>
				</div>
				<div class="footer-bottom">
					<p>&copy; 2008- <span id="current-year"></span> Associazione Santa Barbara APS. Tutti i diritti riservati. </p>
				</div>
			</div>
		</footer>
		<script src="assets/js/notifications.js"></script>
		<script src="assets/js/script.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<!-- Supabase Authentication Protection Script -->
		<script>
			// Initialize Supabase
			const {
				createClient
			} = supabase;
			const supabaseClient = createClient('https://ciezrbsolxpjxswdkkpo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpZXpyYnNvbHhwanhzd2Rra3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjM1NjAsImV4cCI6MjA2ODQ5OTU2MH0.V-U8KhO8byObUW5kJ8XbLBkp9O9Efh98MdbKYFfbQJk');
			// Global variables (currentUser is already declared in script.js)
			let userRole = null;
			// DOM Elements
			const loadingScreen = document.getElementById('loading-screen');
			const loginPrompt = document.getElementById('login-prompt');
			const membersContent = document.getElementById('members-content');
			const userInfo = document.getElementById('user-info');
			const logoutBtn = document.getElementById('logout-btn');
			// Utility Functions
			function showLoading() {
				if (loadingScreen) {
					loadingScreen.style.display = 'flex';
				}
				if (loginPrompt) loginPrompt.style.display = 'none';
				if (membersContent) membersContent.style.display = 'none';
			}

			function hideLoading() {
				if (loadingScreen) {
					loadingScreen.style.display = 'none';
				}
			}

			function showLoginPrompt() {
				hideLoading();
				if (loginPrompt) loginPrompt.style.display = 'block';
				if (membersContent) membersContent.style.display = 'none';
			}

function showMembersContent() {
	hideLoading();
	if (loginPrompt) loginPrompt.style.display = 'none';
	if (membersContent) {
		membersContent.style.display = 'block';
		membersContent.classList.add('show');
	}
	// Mostra tutte le sezioni riservate
	const dashboardSection = document.querySelector('.dashboard-section');
	if (dashboardSection) dashboardSection.style.display = 'block';
	document.querySelectorAll('.col-md-3').forEach(el => el.style.display = 'block');
	const membersEvents = document.querySelector('.members-events');
	if (membersEvents) membersEvents.style.display = 'block';
	const membersDocuments = document.querySelector('.members-documents');
	if (membersDocuments) membersDocuments.style.display = 'block';
}

			function updateUserInfo(user, metadata) {
				if (!userInfo) return;
				// Estrai informazioni dall'utente e metadata
				const role = metadata?.role || 'utente';
				const firstName = metadata?.first_name || '';
				const lastName = metadata?.last_name || '';
				const fullName = metadata?.full_name || (firstName && lastName ? `${firstName} ${lastName}` : firstName || lastName || 'Utente');
				const phoneNumber = metadata?.phone_number || metadata?.phone || '';
				const dateOfBirth = metadata?.date_of_birth || '';
				const address = metadata?.address || '';
				const membershipDate = metadata?.membership_date || '';
				const membershipNumber = metadata?.membership_number || '';
				// Calcola giorni dall'ultimo accesso
				const lastSignIn = new Date(user.last_sign_in_at || user.created_at);
				const today = new Date();
				const daysSinceLastAccess = Math.floor((today - lastSignIn) / (1000 * 60 * 60 * 24));
				// Formatta la data di ultimo accesso
				const lastAccessText = daysSinceLastAccess === 0 ? 'Oggi' : daysSinceLastAccess === 1 ? 'Ieri' : `${daysSinceLastAccess} giorni fa`;
				userInfo.innerHTML = `
					
									<div class="user-card">
										<div class="user-details">
											<h3>${fullName}</h3>
											<p class="user-email">‚úâÔ∏è ${user.email}</p>
							${phoneNumber ? `
											<p class="user-phone">üìû ${phoneNumber}</p>` : ''}
							
											<span class="user-role ${role}">${role === 'socio' ? 'Socio' : 'Utente'}</span>
										</div>
									</div>
									<div class="user-stats">
										<div class="stat">
											<span class="stat-label">Ultimo accesso</span>
											<span class="stat-value">${lastAccessText}</span>
										</div>
										<div class="stat">
											<span class="stat-label">Stato account</span>
											<span class="stat-value">‚úÖ Attivo</span>
										</div>
						${membershipNumber ? `
						
										<div class="stat">
											<span class="stat-label">N. Tessera</span>
											<span class="stat-value">#${membershipNumber}</span>
										</div>` : ''}
						${membershipDate ? `
						
										<div class="stat">
											<span class="stat-label">Socio dal</span>
											<span class="stat-value">${new Date(membershipDate).toLocaleDateString('it-IT')}</span>
										</div>` : ''}
					
									</div>
					${address || dateOfBirth ? `
					
									<div class="user-additional-info" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
						${address ? `
										<p style="margin-bottom: 10px; opacity: 0.9;">
											<strong>üìç Indirizzo:</strong> ${address}
										</p>` : ''}
						${dateOfBirth ? `
										<p style="margin-bottom: 10px; opacity: 0.9;">
											<strong>üéÇ Data di nascita:</strong> ${new Date(dateOfBirth).toLocaleDateString('it-IT')}
										</p>` : ''}
					
									</div>` : ''}
				`;
			}
			// Authentication Functions
			async function checkAuthentication() {
				showLoading();
				try {
					// Get current session
					const {
						data: {
							session
						},
						error
					} = await supabaseClient.auth.getSession();
					if (error) {
						console.error('Error checking session:', error);
						showLoginPrompt();
						return;
					}
					if (!session || !session.user) {
						// No active session, redirect to login
						setTimeout(() => {
							window.location.href = 'login.html';
						}, 1000);
						return;
					}
					// Check if email is confirmed
					if (!session.user.email_confirmed_at) {
						showLoginPrompt();
						if (loginPrompt) {
							loginPrompt.innerHTML = `
							
			
			
									<div class="auth-prompt">
										<h2>‚ö†Ô∏è Email non confermata</h2>
										<p>Il tuo account non √® ancora stato confermato.</p>
										<p>Controlla la tua casella di posta e clicca sul link di conferma.</p>
										<div class="auth-actions">
											<button onclick="resendConfirmation()" class="btn btn-primary">Invia di nuovo email</button>
											<a href="login.html" class="btn btn-secondary">Torna al Login</a>
										</div>
									</div>
						`;
						}
						return;
					}
					// User is authenticated and confirmed
					currentUser = session.user;
					let userMetadata = session.user.user_metadata;
					userRole = userMetadata?.role || 'utente';
					// Try to fetch additional user profile data from profiles table
					try {
const {
	data: profileData,
	error: profileError
} = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
						if (!profileError && profileData) {
							// Merge profile data with user metadata
							userMetadata = {
								...userMetadata,
								...profileData
							};
							userRole = profileData.role || userMetadata?.role || 'utente';
						}
					} catch (profileError) {
						console.log('Profile table not found or no additional data:', profileError);
						// Continue with just the metadata from auth
					}
					// Check if user has access (socio role)
					if (userRole !== 'socio') {
						showLoginPrompt();
						if (loginPrompt) {
							loginPrompt.innerHTML = `
							
			
			
									<div class="auth-prompt">
										<h2>üîí Accesso Limitato</h2>
										<p>Il tuo account √® attivo ma non hai i permessi per accedere all'area soci.</p>
										<p>Contatta l'amministrazione per richiedere l'attivazione come socio.</p>
										<div class="contact-info">
											<p>üìß 
						
						
												<strong>Email:</strong> info@associazionesbarbara.it
					
					
											</p>
											<p>üìç 
						
						
												<strong>Sede:</strong> Via N. Mastroserio 12, Grumo Appula (BA)
					
					
											</p>
										</div>
										<div class="auth-actions">
											<button onclick="handleLogout()" class="btn btn-secondary">Logout</button>
											<a href="index.html" class="btn btn-primary">Torna alla Home</a>
										</div>
									</div>
						`;
						}
						return;
					}
					// User has access, show members content
					updateUserInfo(currentUser, userMetadata);
					showMembersContent();
				} catch (error) {
					console.error('Authentication check failed:', error);
					showLoginPrompt();
				}
			}
			// Resend confirmation email
			async function resendConfirmation() {
				try {
					const {
						error
					} = await supabaseClient.auth.resend({
						type: 'signup',
						email: currentUser?.email
					});
					if (error) {
						notify.error('Errore nell\'invio dell\'email: ' + error.message);
					} else {
						notify.success('Email di conferma inviata! Controlla la tua casella di posta.');
					}
				} catch (error) {
					console.error('Error resending confirmation:', error);
					notify.error('Errore nell\'invio dell\'email di conferma.');
				}
			}
			// Logout function
			async function handleLogout() {
				try {
					const {
						error
					} = await supabaseClient.auth.signOut();
					if (error) {
						console.error('Logout error:', error);
						notify.error('Errore durante il logout: ' + error.message);
					} else {
						notify.info('Logout effettuato con successo. Arrivederci!');
						// Redirect to home page after successful logout
						setTimeout(() => {
							window.location.href = 'index.html';
						}, 1000);
					}
				} catch (error) {
					console.error('Logout failed:', error);
					notify.error('Errore durante il logout.');
				}
			}
			// Auth state change listener
			supabaseClient.auth.onAuthStateChange((event, session) => {
				console.log('Auth state changed:', event, session);
				if (event === 'SIGNED_OUT' || !session) {
					// User signed out or session expired
					window.location.href = 'login.html';
				} else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
					// User signed in or token refreshed
					checkAuthentication();
				}
			});
			// Profile Management Functions

			function hideAllForms() {
				const editForm = document.getElementById('profile-edit-form');
				const passwordForm = document.getElementById('password-change-form');
				const emailForm = document.getElementById('email-change-form');
				if (editForm) editForm.style.display = 'none';
				if (passwordForm) passwordForm.style.display = 'none';
				if (emailForm) emailForm.style.display = 'none';
				// Rimuovi stato attivo da tutti i pulsanti
				document.getElementById('edit-profile-btn')?.classList.remove('btn-active');
				document.getElementById('change-password-btn')?.classList.remove('btn-active');
				document.getElementById('change-email-btn')?.classList.remove('btn-active');
			}

			function showEditProfile() {
				hideAllForms();
				const editForm = document.getElementById('profile-edit-form');
				const btn = document.getElementById('edit-profile-btn');
				if (editForm) {
					editForm.style.display = 'block';
					populateEditForm();
				}
				if (btn) btn.classList.add('btn-active');
			}

			function hideEditProfile() {
				const editForm = document.getElementById('profile-edit-form');
				if (editForm) editForm.style.display = 'none';
			}

			function showChangePassword() {
				hideAllForms();
				const passwordForm = document.getElementById('password-change-form');
				const btn = document.getElementById('change-password-btn');
				if (passwordForm) passwordForm.style.display = 'block';
				if (btn) btn.classList.add('btn-active');
			}

			function hideChangePassword() {
				const passwordForm = document.getElementById('password-change-form');
				if (passwordForm) passwordForm.style.display = 'none';
			}

			function showChangeEmail() {
				hideAllForms();
				const emailForm = document.getElementById('email-change-form');
				const btn = document.getElementById('change-email-btn');
				if (emailForm) emailForm.style.display = 'block';
				if (btn) btn.classList.add('btn-active');
			}
			
			function populateEditForm() {
				if (!currentUser) return;
				// Usa user_metadata gi√† merge-ato con i dati del profilo (come fatto in checkAuthentication)
				const metadata = currentUser.user_metadata || {};
				// Informazioni Personali
				document.getElementById('edit-firstName').value = metadata.first_name || '';
				document.getElementById('edit-lastName').value = metadata.last_name || '';
				document.getElementById('edit-dateOfBirth').value = metadata.date_of_birth || '';
				document.getElementById('edit-placeOfBirth').value = metadata.place_of_birth || '';
				document.getElementById('edit-gender').value = metadata.gender || '';
				document.getElementById('edit-fiscalCode').value = metadata.fiscal_code || '';
				// Contatti
				document.getElementById('edit-phone').value = metadata.phone_number || metadata.phone || '';
				// Indirizzo
				document.getElementById('edit-address').value = metadata.address || '';
				document.getElementById('edit-city').value = metadata.city || '';
				document.getElementById('edit-zipCode').value = metadata.zip_code || '';
				document.getElementById('edit-province').value = metadata.province || '';
			}
			
			async function handleProfileUpdate(event) {
				event.preventDefault();
				
				const submitBtn = event.target.querySelector('button[type="submit"]');
				const originalText = submitBtn.innerHTML;
				
				// Show loading state
				submitBtn.disabled = true;
				submitBtn.innerHTML = '‚è≥ Salvando...';
				
				const formData = new FormData(event.target);
				
				// Validate fiscal code format if provided
				const fiscalCode = formData.get('fiscalCode')?.toUpperCase().trim();
				if (fiscalCode && !/^[A-Z0-9]{16}$/.test(fiscalCode)) {
					notify.error('Il codice fiscale deve essere di 16 caratteri alfanumerici');
					submitBtn.disabled = false;
					submitBtn.innerHTML = originalText;
					return;
				}
				
				// Validate ZIP code format if provided
				const zipCode = formData.get('zipCode');
				if (zipCode && !/^\d{5}$/.test(zipCode)) {
					notify.error('Il CAP deve essere di 5 cifre');
					submitBtn.disabled = false;
					submitBtn.innerHTML = originalText;
					return;
				}
				
				// Validate province format if provided
				const province = formData.get('province')?.toUpperCase().trim();
				if (province && !/^[A-Z]{2}$/.test(province)) {
					notify.error('La provincia deve essere di 2 lettere maiuscole');
					submitBtn.disabled = false;
					submitBtn.innerHTML = originalText;
					return;
				}
				
				const updateData = {
					// Informazioni Personali
					first_name: formData.get('firstName'),
					last_name: formData.get('lastName'),
					date_of_birth: formData.get('dateOfBirth') || null,
					place_of_birth: formData.get('placeOfBirth') || null,
					gender: formData.get('gender') || null,
					fiscal_code: fiscalCode || null,
					
					// Contatti
					phone_number: formData.get('phone') || null,
					phone: formData.get('phone') || null, // Keep both for compatibility
					
					// Indirizzo
					address: formData.get('address') || null,
					city: formData.get('city') || null,
					zip_code: zipCode || null,
					province: province || null,
					
				};
				
				try {
					// Update user metadata in Supabase Auth
					const { error: authError } = await supabaseClient.auth.updateUser({
						data: updateData
					});
					
					if (authError) throw authError;
					
					// Also try to update profiles table if it exists
					try {
						const profileUpdateData = {
							first_name: updateData.first_name,
							last_name: updateData.last_name,
							date_of_birth: updateData.date_of_birth,
							place_of_birth: updateData.place_of_birth,
							gender: updateData.gender,
							fiscal_code: updateData.fiscal_code,
							phone: updateData.phone_number,
							address: updateData.address,
							city: updateData.city,
							zip_code: updateData.zip_code,
							province: updateData.province,
							updated_at: new Date().toISOString()
						};
						
						const { error: profileError } = await supabaseClient
							.from('profiles')
							.update(profileUpdateData)
							.eq('id', currentUser.id);
							
						if (profileError) {
							console.warn('Profile table update failed:', profileError);
							// Don't throw error - auth update succeeded
						}
					} catch (profileError) {
						console.warn('Profiles table not accessible:', profileError);
						// Continue - auth metadata update succeeded
					}
					
					notify.success('Profilo aggiornato con successo!');
					hideEditProfile();
					// Refresh user info
					checkAuthentication();
					
				} catch (error) {
					console.error('Profile update error:', error);
					notify.error('Errore durante l\'aggiornamento del profilo: ' + error.message);
				} finally {
					// Reset button state
					submitBtn.disabled = false;
					submitBtn.innerHTML = originalText;
				}
			}
			
			async function handlePasswordChange(event) {
				event.preventDefault();
				
				const submitBtn = event.target.querySelector('button[type="submit"]');
				const originalText = submitBtn.innerHTML;
				
				const formData = new FormData(event.target);
				const currentPassword = formData.get('currentPassword');
				const newPassword = formData.get('newPassword');
				const confirmPassword = formData.get('confirmPassword');
				
				// Validate passwords match
				if (newPassword !== confirmPassword) {
					notify.error('Le password non coincidono');
					return;
				}
				
				// Validate password length
				if (newPassword.length < 6) {
					notify.error('La password deve essere lunga almeno 6 caratteri');
					return;
				}
				
				// Show loading state
				submitBtn.disabled = true;
				submitBtn.innerHTML = '‚è≥ Cambiando...';
				
				try {
					const { error } = await supabaseClient.auth.updateUser({
						password: newPassword
					});
					
					if (error) throw error;
					
					notify.success('Password cambiata con successo!');
					hideChangePassword();
					
					// Clear form
					document.getElementById('update-password-form').reset();
					
				} catch (error) {
					console.error('Password change error:', error);
					notify.error('Errore durante il cambio password: ' + error.message);
				} finally {
					// Reset button state
					submitBtn.disabled = false;
					submitBtn.innerHTML = originalText;
				}
			}

			// Event Listeners
			document.addEventListener('DOMContentLoaded', function() {
				// Add logout button event listener
				if (logoutBtn) {
					logoutBtn.addEventListener('click', handleLogout);
				}
				
				// Profile management buttons
				const editProfileBtn = document.getElementById('edit-profile-btn');
				const changePasswordBtn = document.getElementById('change-password-btn');
				const cancelEditBtn = document.getElementById('cancel-edit-btn');
				const cancelPasswordBtn = document.getElementById('cancel-password-btn');
				const updateProfileForm = document.getElementById('update-profile-form');
				const updatePasswordForm = document.getElementById('update-password-form');
				
				if (editProfileBtn) {
					editProfileBtn.addEventListener('click', showEditProfile);
				}
				if (changePasswordBtn) {
					changePasswordBtn.addEventListener('click', showChangePassword);
				}
				const changeEmailBtn = document.getElementById('change-email-btn');
				if (changeEmailBtn) {
					changeEmailBtn.addEventListener('click', showChangeEmail);
				}
				if (cancelEditBtn) {
					cancelEditBtn.addEventListener('click', hideEditProfile);
				}
				if (cancelPasswordBtn) {
					cancelPasswordBtn.addEventListener('click', hideChangePassword);
				}
				if (updateProfileForm) {
					updateProfileForm.addEventListener('submit', handleProfileUpdate);
				}
				if (updatePasswordForm) {
					updatePasswordForm.addEventListener('submit', handlePasswordChange);
				}
				
				// Check authentication on page load
				checkAuthentication();
			});
			// Global functions for buttons
			window.resendConfirmation = resendConfirmation;
			window.handleLogout = handleLogout;
		</script>
	</body>
</html>