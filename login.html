<!DOCTYPE html>
<html lang="it">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Login - Associazione Santa Barbara APS</title>
		<meta name="description" content="Accedi al tuo account dell'Associazione Santa Barbara APS">
		<meta name="keywords" content="login, accesso, associazione santa barbara">
		<link rel="stylesheet" href="assets/css/style.css">
		<link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
		<!-- Google tag (gtag.js) with Consent Mode -->
		<script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('consent', 'default', {
				'ad_storage': 'denied',
				'ad_user_data': 'denied',
				'ad_personalization': 'denied',
				'analytics_storage': 'denied',
				'wait_for_update': 500
			});
		</script>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-F465WJF33T"></script>
		<script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());
			gtag('config', 'G-F465WJF33T');
		</script>
	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar">
			<div class="container">
				<div class="nav-brand">
					<img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="logo">
					<span class="brand-text">Associazione Santa Barbara APS</span>
				</div>
				<button class="nav-toggle" aria-label="Toggle navigation">
					<span></span>
					<span></span>
					<span></span>
				</button>
				<ul class="nav-menu">
					<li>
						<a href="index.html">Home</a>
					</li>
					<li>
						<a href="chi-siamo.html">Chi Siamo</a>
					</li>
					<li>
						<a href="attivita.html">Attivit√†</a>
					</li>
					<li>
						<a href="eventi.html">Eventi</a>
					</li>
					<li>
						<a href="galleria.html">Galleria</a>
					</li>
					<li>
						<a href="partner.html">Partner</a>
					</li>
					<li>
						<a href="faq.html">FAQ</a>
					</li>
					<li>
						<a href="contatti.html">Contatti</a>
					</li>
					<li>
						<a href="area-soci.html" class="btn-nav">Area Soci</a>
					</li>
				</ul>
			</div>
		</nav>
		<!-- Login Section -->
		<section class="auth-section">
			<div class="container">
				<div class="auth-container">
					<div class="auth-header">
						<h1>Accedi al tuo Account</h1>
						<p>Inserisci le tue credenziali per accedere all'area riservata</p>
					</div>
					<!-- Login Form -->
					<div class="auth-form-container">
						<form id="loginForm" class="auth-form" data-type="login">
							<div class="form-group">
								<label for="email">Email</label>
								<input type="email" id="email" name="email" required>
							</div>
							<div class="form-group">
								<label for="password">Password</label>
								<input type="password" id="password" name="password" required>
							</div>
							<button type="submit" class="btn btn-primary btn-full" id="loginButton">
								<span class="btn-text">Accedi</span>
								<div class="loading-spinner" style="display: none;"></div>
							</button>
						</form>
						<!-- Status Messages -->
						<div id="statusMessage" class="status-message" style="display: none;"></div>
						
						<!-- Resend Verification Email -->
						<div id="resendEmailSection" class="resend-email-section" style="display: none; margin: 15px 0;">
							<p class="text-center" style="color: #666; margin-bottom: 10px;">Non hai ricevuto l'email di conferma?</p>
							<button type="button" id="resendEmailBtn" class="btn btn-secondary btn-full">
								<span class="btn-text">Invia di nuovo email di conferma</span>
								<div class="loading-spinner" style="display: none;"></div>
							</button>
						</div>
						
						<!-- Auth Links -->
						<div class="auth-links">
							<p>Non hai un account? <a href="register.html">Registrati qui</a>
							</p>
							<p>
								<a href="index.html">‚Üê Torna alla Home</a>
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- Footer -->
		<footer class="footer">
			<div class="container">
				<div class="footer-content">
					<div class="footer-section">
						<h3>Associazione Santa Barbara APS</h3>
						<p>Preserviamo le tradizioni di Grumo Appula dal 2008</p>
						<div class="social-links">
							<a href="https://www.facebook.com/santabarbara.grumoappula" target="_blank" aria-label="Facebook">üìò</a>
							<a href="https://www.instagram.com/corteostoricosantabarbara" target="_blank" aria-label="Instagram">üì∑</a>
							<a href="https://t.me/associazionesbarbara" target="_blank" aria-label="Telegram">‚úàÔ∏è</a>
						</div>
					</div>
					<div class="footer-section">
						<h4>Contatti</h4>
						<p>üìç Via N. Mastroserio 12, Grumo Appula (BA)</p>
						<p>üìß info@associazionesbarbara.it</p>
					</div>
				</div>
				<div class="footer-bottom">
					<p>&copy; <span id="current-year">2025</span> Associazione Santa Barbara APS. Tutti i diritti riservati. </p>
					<p>
						<a href="privacy.html">Privacy Policy</a>
					</p>
				</div>
			</div>
		</footer>
		<!-- Cookie Banner -->
		<div id="cookieBanner" class="cookie-banner" style="display: none;">
			<div class="cookie-content">
				<p>Questo sito utilizza cookie per migliorare l'esperienza di navigazione. Continuando a navigare accetti l'uso dei cookie.</p>
				<div class="cookie-buttons">
					<button id="acceptCookies" class="btn btn-primary">Accetta</button>
					<button id="rejectCookies" class="btn btn-secondary">Rifiuta</button>
					<a href="privacy.html" class="btn btn-link">Privacy Policy</a>
				</div>
			</div>
		</div>
		<!-- Scripts -->
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<script src="assets/js/script.js"></script>
		<!-- Supabase Authentication Script -->
		<script>
			// Initialize Supabase
			const {
				createClient
			} = supabase;
			const supabaseClient = createClient('https://ciezrbsolxpjxswdkkpo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpZXpyYnNvbHhwanhzd2Rra3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjM1NjAsImV4cCI6MjA2ODQ5OTU2MH0.V-U8KhO8byObUW5kJ8XbLBkp9O9Efh98MdbKYFfbQJk');
			// DOM Elements
			const loginForm = document.getElementById('loginForm');
			const emailInput = document.getElementById('email');
			const passwordInput = document.getElementById('password');
			const loginButton = document.getElementById('loginButton');
			const statusMessage = document.getElementById('statusMessage');
			const btnText = loginButton.querySelector('.btn-text');
			const loadingSpinner = loginButton.querySelector('.loading-spinner');
			// Utility Functions
			function showStatus(message, type = 'info') {
				statusMessage.className = `status-message ${type}`;
				statusMessage.innerHTML = message;
				statusMessage.style.display = 'block';
			}

			function hideStatus() {
				statusMessage.style.display = 'none';
			}

			function setLoading(isLoading) {
				if (isLoading) {
					btnText.style.display = 'none';
					loadingSpinner.style.display = 'block';
					loginButton.disabled = true;
				} else {
					btnText.style.display = 'block';
					loadingSpinner.style.display = 'none';
					loginButton.disabled = false;
				}
			}
			// Check if user is already logged in
			async function checkExistingSession() {
				try {
					const {
						data: {
							session
						},
						error
					} = await supabaseClient.auth.getSession();
					if (error) {
						console.error('Error checking session:', error);
						return;
					}
					if (session) {
						// User is already logged in, redirect to area soci
						showStatus('Sessione esistente trovata, reindirizzamento...', 'success');
						setTimeout(() => {
							window.location.href = 'area-soci.html';
						}, 1000);
					}
				} catch (error) {
					console.error('Error checking existing session:', error);
				}
			}
			// Login Function
			async function handleLogin(event) {
				event.preventDefault();
				hideStatus();
				const email = emailInput.value.trim();
				const password = passwordInput.value;
				// Validation
				if (!email || !password) {
					showStatus('Inserisci email e password.', 'error');
					return;
				}
				if (!email.includes('@')) {
					showStatus('Inserisci un indirizzo email valido.', 'error');
					return;
				}
				setLoading(true);
				try {
					// Sign in with Supabase
					const {
						data,
						error
					} = await supabaseClient.auth.signInWithPassword({
						email: email,
						password: password
					});
					if (error) {
						throw error;
					}
					if (data.user) {
						// Check if email is confirmed
						if (!data.user.email_confirmed_at) {
							showStatus('Email non confermata. Controlla la tua casella di posta e clicca sul link di conferma.', 'warning');
							setLoading(false);
							return;
						}
						showStatus('Login effettuato con successo! Reindirizzamento...', 'success');
						// Redirect to area soci after successful login
						setTimeout(() => {
							window.location.href = 'area-soci.html';
						}, 1500);
					} else {
						throw new Error('Errore durante il login');
					}
				} catch (error) {
					console.error('Login error:', error);
					let errorMessage = 'Errore durante il login. ';
					if (error.message.includes('Invalid login credentials')) {
						errorMessage = 'Email o password non corretti.';
					} else if (error.message.includes('Email not confirmed')) {
						errorMessage = 'Email non confermata. Controlla la tua casella di posta.';
						// Show resend email section when email is not confirmed
						document.getElementById('resendEmailSection').style.display = 'block';
					} else if (error.message.includes('Too many requests')) {
						errorMessage = 'Troppi tentativi di login. Riprova tra qualche minuto.';
					} else {
						errorMessage += error.message;
					}
					showStatus(errorMessage, 'error');
				} finally {
					setLoading(false);
				}
			}
			// Resend verification email function
			async function resendVerificationEmail() {
				const email = emailInput.value.trim();
				
				if (!email) {
					showStatus('Inserisci il tuo indirizzo email prima di richiedere una nuova email di conferma.', 'error');
					return;
				}

				const resendBtn = document.getElementById('resendEmailBtn');
				const btnText = resendBtn.querySelector('.btn-text');
				const spinner = resendBtn.querySelector('.loading-spinner');
				
				// Set loading state
				btnText.textContent = 'Invio in corso...';
				spinner.style.display = 'inline-block';
				resendBtn.disabled = true;

				try {
					const { error } = await supabaseClient.auth.resend({
						type: 'signup',
						email: email
					});

					if (error) {
						throw error;
					}

					showStatus('Email di conferma inviata! Controlla la tua casella di posta.', 'success');
					
				} catch (error) {
					console.error('Resend email error:', error);
					let errorMessage = 'Errore durante l\'invio dell\'email. ';
					
					if (error.message.includes('User not found')) {
						errorMessage = 'Email non trovata. Verifica di aver inserito l\'email corretta.';
					} else if (error.message.includes('Email rate limit')) {
						errorMessage = 'Limite di invio raggiunto. Riprova tra qualche minuto.';
					} else {
						errorMessage += error.message;
					}
					
					showStatus(errorMessage, 'error');
				} finally {
					// Reset button state
					btnText.textContent = 'Invia di nuovo email di conferma';
					spinner.style.display = 'none';
					resendBtn.disabled = false;
				}
			}

			// Hide resend section when form is focused again
			function hideResendSection() {
				document.getElementById('resendEmailSection').style.display = 'none';
			}

			// Event Listeners
			loginForm.addEventListener('submit', handleLogin);
			document.getElementById('resendEmailBtn').addEventListener('click', resendVerificationEmail);
			
			// Hide resend section when user starts typing again
			emailInput.addEventListener('focus', hideResendSection);
			passwordInput.addEventListener('focus', hideResendSection);
			
			// Check for existing session on page load
			document.addEventListener('DOMContentLoaded', checkExistingSession);
			// Auto-focus email field
			document.addEventListener('DOMContentLoaded', () => {
				emailInput.focus();
			});
		</script>
	</body>
</html>