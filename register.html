<!DOCTYPE html>
<html lang="it">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Registrati - Associazione Santa Barbara APS</title>
		<meta name="description" content="Crea un account per l'Associazione Santa Barbara APS">
		<meta name="keywords" content="registrazione, account, associazione santa barbara">
		<link rel="stylesheet" href="assets/css/style.css">
		<link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
		<!-- Google tag (gtag.js) with Consent Mode -->
		<script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('consent', 'default', {
				'ad_storage': 'denied',
				'ad_user_data': 'denied',
				'ad_personalization': 'denied',
				'analytics_storage': 'denied',
				'wait_for_update': 500
			});
		</script>
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-F465WJF33T"></script>
		<script>
			window.dataLayer = window.dataLayer || [];

			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());
			gtag('config', 'G-F465WJF33T');
		</script>
	</head>
	<body>
		<!-- Navigation -->
		<nav class="navbar">
			<div class="container">
				<div class="nav-brand">
					<a href="index.html" class="nav-brand-link">
						<img src="assets/images/logo.svg" alt="Logo Associazione Santa Barbara APS" class="logo">
						<span class="brand-text">Associazione Santa Barbara APS</span>
					</a>
				</div>
				<button class="nav-toggle" aria-label="Toggle navigation">
					<span></span>
					<span></span>
					<span></span>
				</button>
				<ul class="nav-menu">
					<li>
						<a href="index.html" class="nav-link">Home</a>
					</li>
					<li>
						<a href="chi-siamo.html" class="nav-link">Chi siamo</a>
					</li>
					<li>
						<a href="attivita.html" class="nav-link">Attivit√†</a>
					</li>
					<li>
						<a href="eventi.html" class="nav-link">Eventi</a>
					</li>
					<li>
						<a href="galleria.html" class="nav-link">Galleria</a>
					</li>
					<li>
						<a href="faq.html" class="nav-link">FAQ</a>
					</li>
					<li>
						<a href="partner.html" class="nav-link">Partner</a>
					</li>
					<li>
						<a href="contatti.html" class="nav-link">Contatti</a>
					</li>
					<li>
						<a href="area-soci.html" class="nav-link btn btn-primary">Area Soci</a>
					</li>
				</ul>
			</div>
		</nav>
		<!-- Register Section -->
		<section class="auth-section">
			<div class="container">
				<div class="auth-container">
					<div class="auth-header">
						<h1>Crea il tuo Account</h1>
						<p>Registrati per accedere ai contenuti riservati ai soci</p>
					</div>
					<!-- Registration Form -->
					<div class="auth-form-container">
						<form id="registerForm" class="auth-form">
							<!-- Sezione Informazioni Personali -->
							<div class="form-section">
								<h3>üìã Informazioni Personali</h3>
								<div class="form-row">
									<div class="form-group">
										<label for="firstName">Nome *</label>
										<input type="text" id="firstName" name="firstName" required>
									</div>
									<div class="form-group">
										<label for="lastName">Cognome *</label>
										<input type="text" id="lastName" name="lastName" required>
									</div>
								</div>
								<div class="form-row">
									<div class="form-group">
										<label for="dateOfBirth">Data di Nascita *</label>
										<input type="date" id="dateOfBirth" name="dateOfBirth" required>
									</div>
									<div class="form-group">
										<label for="placeOfBirth">Luogo di Nascita *</label>
										<input type="text" id="placeOfBirth" name="placeOfBirth" placeholder="Es. Grumo Appula" required>
									</div>
								</div>
								<div class="form-row">
									<div class="form-group">
										<label for="gender">Sesso *</label>
										<select id="gender" name="gender" required>
											<option value="">Seleziona...</option>
											<option value="M">Maschio</option>
											<option value="F">Femmina</option>
										</select>
									</div>
									<div class="form-group">
										<label for="fiscalCode">Codice Fiscale</label>
										<input type="text" id="fiscalCode" name="fiscalCode" maxlength="16" placeholder="Verr√† calcolato automaticamente" readonly>
										<small class="form-help" id="fiscalCodeHelp">Compila i campi sopra per il calcolo automatico</small>
									</div>
								</div>
							</div>
							<!-- Sezione Contatti -->
							<div class="form-section">
								<h3>üìß Contatti</h3>
								<div class="form-group">
									<label for="email">Email *</label>
									<input type="email" id="email" name="email" required>
								</div>
								<div class="form-group">
									<label for="phoneNumber">Telefono</label>
									<input type="tel" id="phoneNumber" name="phoneNumber" placeholder="+39 320 123 4567">
								</div>
							</div>
							<!-- Sezione Indirizzo -->
							<div class="form-section">
								<h3>üè† Indirizzo</h3>
								<div class="form-group">
									<label for="address">Indirizzo</label>
									<input type="text" id="address" name="address" placeholder="Via N. Mastroserio 12">
								</div>
								<div class="form-row">
									<div class="form-group">
										<label for="city">Citt√†</label>
										<input type="text" id="city" name="city" placeholder="Grumo Appula">
									</div>
									<div class="form-group">
										<label for="zipCode">CAP</label>
										<input type="text" id="zipCode" name="zipCode" maxlength="5" placeholder="70025">
									</div>
								</div>
								<div class="form-group">
									<label for="province">Provincia (2 lettere)</label>
									<input type="text" id="province" name="province" maxlength="2" placeholder="BA">
								</div>
							</div>
							<!-- Sezione Account -->
							<div class="form-section">
								<h3>üîê Credenziali di Accesso</h3>
								<div class="form-group">
									<label for="password">Password *</label>
									<input type="password" id="password" name="password" required>
									<small class="password-help">Minimo 8 caratteri con lettere maiuscole, minuscole, numeri e simboli</small>
								</div>
								<div class="form-group">
									<label for="confirmPassword">Conferma Password *</label>
									<input type="password" id="confirmPassword" name="confirmPassword" required>
								</div>
							</div>
							<!-- Sezione Consensi -->
							<div class="form-section">
								<h3>‚úÖ Consensi e Privacy</h3>
								<div class="form-group checkbox-group">
									<label class="checkbox-label">
										<input type="checkbox" id="acceptTerms" name="acceptTerms" required>
										<span class="checkmark"></span> Accetto i <a href="privacy.html" target="_blank">Termini e Condizioni</a> e l' <a href="privacy.html" target="_blank">Informativa sulla Privacy</a> * </label>
								</div>
							</div>
							<button type="submit" class="btn btn-primary btn-full" id="registerButton">
								<span class="btn-text">Registrati</span>
								<div class="loading-spinner" style="display: none;"></div>
							</button>
						</form>
						<!-- Status Messages -->
						<div id="statusMessage" class="status-message" style="display: none;"></div>
						<!-- Auth Links -->
						<div class="auth-links">
							<p>Hai gi√† un account? <a href="login.html">Accedi qui</a>
							</p>
							<p>
								<a href="index.html">‚Üê Torna alla Home</a>
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
		<!-- Footer -->
		<footer class="footer">
			<div class="container">
				<div class="footer-content">
					<div class="footer-section">
						<h3>Associazione Santa Barbara APS</h3>
						<p>Preserviamo le tradizioni di Grumo Appula dal 2008</p>
						<div class="social-links">
							<a href="https://www.facebook.com/santabarbara.grumoappula" target="_blank" aria-label="Facebook">üìò</a>
							<a href="https://www.instagram.com/corteostoricosantabarbara" target="_blank" aria-label="Instagram">üì∑</a>
							<a href="https://t.me/associazionesbarbara" target="_blank" aria-label="Telegram">‚úàÔ∏è</a>
						</div>
					</div>
					<div class="footer-section">
						<h4>Contatti</h4>
						<p>üìç Via N. Mastroserio 12, Grumo Appula (BA)</p>
						<p>üìß info@associazionesbarbara.it</p>
					</div>
				</div>
				<div class="footer-bottom">
					<p>&copy; <span id="current-year">2025</span> Associazione Santa Barbara APS. Tutti i diritti riservati.<br>
						<span style="letter-spacing:2px; font-size:0.95em; color:#222;">
							<a href="privacy.html" style="color:#e67e22; text-decoration:underline;">PRIVACY POLICY</a>
							<span style="margin:0 10px;">|</span>
							<a href="#" style="color:#e67e22; text-decoration:underline;" onclick="window.cookieConsent && window.cookieConsent.open(); return false;">GESTISCI COOKIE</a>
						</span>
					</p>
				</div>
			</div>
		</footer>
		<!-- Cookie Banner -->
		<div id="cookieBanner" class="cookie-banner" style="display: none;">
			<div class="cookie-content">
				<p>Questo sito utilizza cookie per migliorare l'esperienza di navigazione. Continuando a navigare accetti l'uso dei cookie.</p>
				<div class="cookie-buttons">
					<button id="acceptCookies" class="btn btn-primary">Accetta</button>
					<button id="rejectCookies" class="btn btn-secondary">Rifiuta</button>
					<a href="privacy.html" class="btn btn-link">Privacy Policy</a>
				</div>
			</div>
		</div>
		<!-- Scripts -->
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<script src="assets/js/notifications.js"></script>
		<script src="assets/js/script.js"></script>
		<!-- Supabase Registration Script -->
		<script>
			// Initialize Supabase
			const {
				createClient
			} = supabase;
			const supabaseClient = createClient('https://ciezrbsolxpjxswdkkpo.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpZXpyYnNvbHhwanhzd2Rra3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MjM1NjAsImV4cCI6MjA2ODQ5OTU2MH0.V-U8KhO8byObUW5kJ8XbLBkp9O9Efh98MdbKYFfbQJk');
			// DOM Elements
			const registerForm = document.getElementById('registerForm');
			const firstNameInput = document.getElementById('firstName');
			const lastNameInput = document.getElementById('lastName');
			const emailInput = document.getElementById('email');
			const passwordInput = document.getElementById('password');
			const confirmPasswordInput = document.getElementById('confirmPassword');
			const acceptTermsInput = document.getElementById('acceptTerms');
			const registerButton = document.getElementById('registerButton');
			const statusMessage = document.getElementById('statusMessage');
			const btnText = registerButton.querySelector('.btn-text');
			const loadingSpinner = registerButton.querySelector('.loading-spinner');
			// Additional form elements
			const dateOfBirthInput = document.getElementById('dateOfBirth');
			const placeOfBirthInput = document.getElementById('placeOfBirth');
			const genderInput = document.getElementById('gender');
			const fiscalCodeInput = document.getElementById('fiscalCode');
			const phoneNumberInput = document.getElementById('phoneNumber');
			const addressInput = document.getElementById('address');
			const cityInput = document.getElementById('city');
			const zipCodeInput = document.getElementById('zipCode');
			const provinceInput = document.getElementById('province');
			// Utility Functions
			function showStatus(message, type = 'info') {
				statusMessage.className = `status-message ${type}`;
				statusMessage.innerHTML = message;
				statusMessage.style.display = 'block';
				statusMessage.scrollIntoView({
					behavior: 'smooth',
					block: 'nearest'
				});
			}

			function hideStatus() {
				statusMessage.style.display = 'none';
			}

			function setLoading(isLoading) {
				if (isLoading) {
					btnText.style.display = 'none';
					loadingSpinner.style.display = 'block';
					registerButton.disabled = true;
				} else {
					btnText.style.display = 'block';
					loadingSpinner.style.display = 'none';
					registerButton.disabled = false;
				}
			}
			// Password validation
			function validatePassword(password) {
				const errors = [];
				if (password.length < 8) {
					errors.push('La password deve essere di almeno 8 caratteri');
				}
				if (!/[a-z]/.test(password)) {
					errors.push('La password deve contenere almeno una lettera minuscola');
				}
				if (!/[A-Z]/.test(password)) {
					errors.push('La password deve contenere almeno una lettera maiuscola');
				}
				if (!/[0-9]/.test(password)) {
					errors.push('La password deve contenere almeno un numero');
				}
				if (!/[!@#$%^&*()_+\-=\[\]{}|;':".,<>?~`]/.test(password)) {
					errors.push('La password deve contenere almeno un simbolo (!@#$%^&* ecc.)');
				}
				return {
					isValid: errors.length === 0,
					errors: errors,
					strength: calculatePasswordStrength(password)
				};
			}
			// Calculate password strength for visual feedback
			function calculatePasswordStrength(password) {
				let strength = 0;
				// Length scoring
				if (password.length >= 8) strength += 1;
				if (password.length >= 12) strength += 1;
				if (password.length >= 16) strength += 1;
				// Character variety scoring
				if (/[a-z]/.test(password)) strength += 1;
				if (/[A-Z]/.test(password)) strength += 1;
				if (/[0-9]/.test(password)) strength += 1;
				if (/[!@#$%^&*()_+\-=\[\]{}|;':".,<>?~`]/.test(password)) strength += 1;
				// Return strength level (0-4)
				return Math.min(strength, 4);
			}
			// Email validation
			function validateEmail(email) {
				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailRegex.test(email)) {
					return 'Inserisci un indirizzo email valido.';
				}
				return null;
			}
			// Fiscal Code API functions
			const FISCAL_CODE_API_KEY = '15ba6b0df94ce0a6ad015ec6dc268365943838c2aea7ed7e94a5f1deda14e6ad68e';
			async function calculateFiscalCode(firstName, lastName, gender, dateOfBirth, placeOfBirth) {
				if (!firstName || !lastName || !gender || !dateOfBirth || !placeOfBirth) {
					return null;
				}
				try {
					const date = new Date(dateOfBirth);
					const day = date.getDate();
					const month = date.getMonth() + 1; // JavaScript months are 0-based
					const year = date.getFullYear();
					const url = `https://api.miocodicefiscale.com/calculate?` + `lname=${encodeURIComponent(lastName)}&` + `fname=${encodeURIComponent(firstName)}&` + `gender=${gender}&` + `city=${encodeURIComponent(placeOfBirth)}&` + `day=${day}&` + `month=${month}&` + `year=${year}&` + `access_token=${FISCAL_CODE_API_KEY}`;
					const response = await fetch(url);
					const data = await response.json();
					if (data.status && data.data && data.data.cf) {
						return data.data.cf;
					} else {
						console.error('Errore calcolo codice fiscale:', data.message);
						return null;
					}
				} catch (error) {
					console.error('Errore nella chiamata API:', error);
					return null;
				}
			}
			async function updateFiscalCode() {
				const firstName = firstNameInput.value.trim();
				const lastName = lastNameInput.value.trim();
				const gender = genderInput.value;
				const dateOfBirth = dateOfBirthInput.value;
				const placeOfBirth = placeOfBirthInput.value.trim();
				const helpElement = document.getElementById('fiscalCodeHelp');
				if (!firstName || !lastName || !gender || !dateOfBirth || !placeOfBirth) {
					fiscalCodeInput.value = '';
					fiscalCodeInput.placeholder = 'Compila tutti i campi per il calcolo automatico';
					helpElement.textContent = 'Compila tutti i campi sopra per il calcolo automatico';
					helpElement.style.color = '#666';
					return;
				}
				helpElement.textContent = 'Calcolo in corso...';
				helpElement.style.color = '#007bff';
				const fiscalCode = await calculateFiscalCode(firstName, lastName, gender, dateOfBirth, placeOfBirth);
				if (fiscalCode) {
					fiscalCodeInput.value = fiscalCode;
					fiscalCodeInput.placeholder = '';
					helpElement.textContent = 'Codice fiscale calcolato automaticamente ‚úì';
					helpElement.style.color = '#28a745';
				} else {
					fiscalCodeInput.value = '';
					fiscalCodeInput.placeholder = 'Errore nel calcolo automatico';
					helpElement.textContent = 'Errore nel calcolo. Verifica i dati inseriti o inserisci manualmente';
					helpElement.style.color = '#dc3545';
					// Allow manual input if API fails
					fiscalCodeInput.removeAttribute('readonly');
				}
			}
			// Check if user is already logged in
			async function checkExistingSession() {
				try {
					const {
						data: {
							session
						},
						error
					} = await supabaseClient.auth.getSession();
					if (error) {
						console.error('Error checking session:', error);
						return;
					}
					if (session) {
						// User is already logged in, redirect to area soci
						showStatus('Sessione esistente trovata, reindirizzamento...', 'success');
						setTimeout(() => {
							window.location.href = 'area-soci.html';
						}, 1000);
					}
				} catch (error) {
					console.error('Error checking existing session:', error);
				}
			}
			// Registration Function
			async function handleRegistration(event) {
				event.preventDefault();
				hideStatus();
				// Get form values - Required fields
				const firstName = firstNameInput.value.trim();
				const lastName = lastNameInput.value.trim();
				const email = emailInput.value.trim();
				const password = passwordInput.value;
				const confirmPassword = confirmPasswordInput.value;
				const acceptTerms = acceptTermsInput.checked;
				const dateOfBirth = dateOfBirthInput.value || null;
				const placeOfBirth = placeOfBirthInput.value.trim() || null;
				const gender = genderInput.value || null;
				// Get form values - Optional fields (convert empty strings to null)
				const fiscalCode = fiscalCodeInput.value.trim().toUpperCase() || null;
				const phoneNumber = phoneNumberInput.value.trim() || null;
				const address = addressInput.value.trim() || null;
				const city = cityInput.value.trim() || 'Grumo Appula';
				const zipCode = zipCodeInput.value.trim() || null;
				const province = provinceInput.value.trim().toUpperCase() || 'BA';
				const profession = professionInput.value.trim() || null;
				// Validation - Required fields
				const missingFields = [{
					label: 'Nome',
					value: firstName
				}, {
					label: 'Cognome',
					value: lastName
				}, {
					label: 'Email',
					value: email
				}, {
					label: 'Password',
					value: password
				}, {
					label: 'Conferma Password',
					value: confirmPassword
				}, {
					label: 'Data di nascita',
					value: dateOfBirth
				}, {
					label: 'Luogo di nascita',
					value: placeOfBirth
				}, {
					label: 'Sesso',
					value: gender
				}].filter(f => !f.value || (typeof f.value === 'string' && f.value.trim() === ''));
				if (missingFields.length > 0 || !(gender === 'M' || gender === 'F')) {
					showStatus('Compila tutti i campi obbligatori (contrassegnati con *).', 'error');
					return;
				}
				const emailError = validateEmail(email);
				if (emailError) {
					showStatus(emailError, 'error');
					return;
				}
				const passwordValidation = validatePassword(password);
				if (!passwordValidation.isValid) {
					showStatus('Password non valida: ' + passwordValidation.errors.join(', '), 'error');
					return;
				}
				if (password !== confirmPassword) {
					showStatus('Le password non coincidono.', 'error');
					return;
				}
				if (!acceptTerms) {
					showStatus('Devi accettare i Termini e Condizioni e l\'Informativa sulla Privacy per procedere.', 'error');
					return;
				}
				// Additional field validation
				if (zipCode && !/^\d{5}$/.test(zipCode)) {
					showStatus('Il CAP deve essere di 5 cifre.', 'error');
					return;
				}
				if (province && !/^[A-Z]{2}$/.test(province)) {
					showStatus('La provincia deve essere di 2 lettere maiuscole (es. BA).', 'error');
					return;
				}
				if (fiscalCode && !/^[A-Z0-9]{16}$/.test(fiscalCode)) {
					showStatus('Il codice fiscale deve essere di 16 caratteri alfanumerici.', 'error');
					return;
				}
				if (phoneNumber && !/^\+?[\d\s\-\(\)]{7,20}$/.test(phoneNumber.replace(/\s/g, ''))) {
					showStatus('Formato numero di telefono non valido. Usa un formato come +39 320 123 4567.', 'error');
					return;
				}

				setLoading(true);
				try {
					// Helper function to convert empty strings to null
					function toNullIfEmpty(value) {
						if (value === undefined || value === null) return null;
						if (typeof value === 'string' && value.trim() === '') return null;
						return typeof value === 'string' ? value.trim() : value;
					}

					// Helper function for date conversion
					function formatDateForDB(dateStr) {
						if (!dateStr || typeof dateStr !== 'string') return null;
						// Ensure YYYY-MM-DD format
						const date = new Date(dateStr);
						if (isNaN(date.getTime())) return null;
						return dateStr; // HTML date input already provides YYYY-MM-DD format
					}

					// Sign up with Supabase Auth
					const {
						data: authData,
						error: authError
					} = await supabaseClient.auth.signUp({
						email: email,
						password: password,
						options: {
							data: {
								first_name: firstName,
								last_name: lastName,
								full_name: `${firstName} ${lastName}`,
								date_of_birth: dateOfBirth,
								place_of_birth: placeOfBirth,
								gender: gender,
								fiscal_code: fiscalCode,
								phone_number: phoneNumber,
								address: address,
								city: city,
								zip_code: zipCode,
								province: province,
								profession: profession,
								privacy_accepted: true,
								registration_completed: true,
								role: 'utente'
							},
							emailRedirectTo: undefined // Disable email confirmation redirect
						}
					});

					if (authError) {
						throw authError;
					}

					if (authData.user) {
						// Build profile data using ONLY existing database columns
						const profileData = {
							id: authData.user.id,
							user_id: authData.user.id, // Required for RLS policies
							email: email // Required field
						};

						// Add optional fields that exist in the database
						if (firstName) profileData.first_name = firstName;
						if (lastName) profileData.last_name = lastName;
						// full_name is a generated column in the database, don't set it manually
						if (dateOfBirth) profileData.date_of_birth = formatDateForDB(dateOfBirth);
						if (placeOfBirth) profileData.place_of_birth = placeOfBirth;
						if (gender) profileData.gender = gender; // Now exists in database
						if (fiscalCode) profileData.fiscal_code = fiscalCode;
						if (phoneNumber) profileData.phone_number = phoneNumber;
						if (address) profileData.address = address;
						if (city) profileData.city = city; // Has default 'Grumo Appula'
						if (zipCode) profileData.zip_code = zipCode;
						if (province) profileData.province = province;
						if (profession) profileData.profession = profession;
						
						// Set privacy accepted to true (user checked the checkbox)
						profileData.privacy_accepted = true;
						
						// Note: created_at and updated_at have default values (now()) so we don't set them
						// Note: role, membership_type, membership_status have defaults so we don't override them

						// Registration data is now saved in user_metadata
						// The profile table entry will be created after email confirmation
						console.log('Registration successful! User data saved in metadata.');
						showStatus(`
							<strong>Registrazione completata!</strong><br>
							Ti abbiamo inviato un'email di conferma all'indirizzo <strong>${email}</strong>.<br>
							Controlla la tua casella di posta e clicca sul link di conferma per attivare il tuo account.<br>
							<small>Una volta confermato, potrai accedere all'area soci se approvato dall'amministrazione.</small>
						`, 'success');

						// Reset form and clear all fields
						registerForm.reset();
						// Clear all input fields explicitly
						firstNameInput.value = '';
						lastNameInput.value = '';
						emailInput.value = '';
						passwordInput.value = '';
						confirmPasswordInput.value = '';
						dateOfBirthInput.value = '';
						placeOfBirthInput.value = '';
						genderInput.value = '';
						fiscalCodeInput.value = '';
						phoneNumberInput.value = '';
						addressInput.value = '';
						cityInput.value = '';
						zipCodeInput.value = '';
						provinceInput.value = '';
						professionInput.value = '';
						acceptTermsInput.checked = false;
						// Reset fiscal code field
						fiscalCodeInput.placeholder = 'Verr√† calcolato automaticamente';
						fiscalCodeInput.setAttribute('readonly', 'readonly');
						const helpElement = document.getElementById('fiscalCodeHelp');
						if (helpElement) {
							helpElement.textContent = 'Compila i campi sopra per il calcolo automatico';
							helpElement.style.color = '#666';
						}
					} else if (authData.user && authData.user.identities && authData.user.identities.length === 0) {
						// User already exists
						showStatus('Un account con questa email esiste gi√†.', 'warning');
					} else {
						throw new Error('Errore durante la registrazione');
					}
				} catch (error) {
					console.error('Registration error:', error);
					let errorMessage = 'Errore durante la registrazione. ';
					if (error.message.includes('User already registered') || error.message.includes('already been registered')) {
						errorMessage = 'Un account con questa email esiste gi√†.';
					} else if (error.message.includes('Password should be at least')) {
						errorMessage = 'La password deve essere di almeno 8 caratteri con lettere maiuscole, minuscole, numeri e simboli.';
					} else if (error.message.includes('Invalid email')) {
						errorMessage = 'Indirizzo email non valido.';
					} else if (error.message.includes('signup disabled')) {
						errorMessage = 'La registrazione √® temporaneamente disabilitata. Riprova pi√π tardi.';
					} else if (error.message.includes('confirmation email')) {
						errorMessage = 'Registrazione completata! Controlla la tua email per il link di conferma.';
						showStatus(errorMessage, 'success');
						registerForm.reset();
						cityInput.value = 'Grumo Appula';
						provinceInput.value = 'BA';
						return;
					} else if (error.message.includes('fiscal_code')) {
						errorMessage = 'Codice fiscale non valido. Controlla il formato.';
					} else if (error.message.includes('phone_number')) {
						errorMessage = 'Numero di telefono non valido. Usa il formato corretto.';
					} else if (error.message.includes('Unable to validate email address')) {
						errorMessage = 'Indirizzo email non valido o gi√† in uso.';
					} else if (error.message.includes('Email not confirmed')) {
						errorMessage = 'Account creato! Controlla la tua email per il link di conferma prima di accedere.';
						showStatus(errorMessage, 'warning');
						registerForm.reset();
						cityInput.value = 'Grumo Appula';
						provinceInput.value = 'BA';
						return;
					} else {
						// For email confirmation errors, treat as success
						if (error.status === 500 && error.message.includes('Error sending')) {
							errorMessage = 'Registrazione completata! Account creato con successo.';
							showStatus(errorMessage, 'success');
							registerForm.reset();
							cityInput.value = 'Grumo Appula';
							provinceInput.value = 'BA';
							return;
						}
						errorMessage += error.message;
					}
					showStatus(errorMessage, 'error');
				} finally {
					setLoading(false);
				}
			}
			// Real-time password validation
			passwordInput.addEventListener('input', function() {
				const password = this.value;
				const helpText = this.nextElementSibling;
				if (password.length > 0 && password.length < 8) {
					helpText.textContent = 'Password troppo corta (minimo 8 caratteri)';
					helpText.style.color = '#d32f2f';
				} else if (password.length >= 8) {
					helpText.textContent = 'Password valida ‚úì';
					helpText.style.color = '#2e7d32';
				} else {
					helpText.textContent = 'Minimo 8 caratteri';
					helpText.style.color = '#666';
				}
			});
			// Real-time confirm password validation
			confirmPasswordInput.addEventListener('input', function() {
				const password = passwordInput.value;
				const confirmPassword = this.value;
				if (confirmPassword.length > 0) {
					if (password === confirmPassword) {
						this.style.borderColor = '#2e7d32';
					} else {
						this.style.borderColor = '#d32f2f';
					}
				} else {
					this.style.borderColor = '#e1e1e1';
				}
			});
			// Event Listeners
			registerForm.addEventListener('submit', handleRegistration);
			// Fiscal code auto-calculation
			firstNameInput.addEventListener('input', updateFiscalCode);
			lastNameInput.addEventListener('input', updateFiscalCode);
			genderInput.addEventListener('change', updateFiscalCode);
			dateOfBirthInput.addEventListener('change', updateFiscalCode);
			placeOfBirthInput.addEventListener('input', updateFiscalCode);
			// Check for existing session on page load
			document.addEventListener('DOMContentLoaded', checkExistingSession);
			// Auto-focus first name field
			document.addEventListener('DOMContentLoaded', () => {
				firstNameInput.focus();
			});
		</script>
	</body>
</html>